(()=>{"use strict";function t(t,e,i,s,a,h,o,r){t.beginPath(),t.moveTo(e+h,i),t.lineTo(e+s-h,i),t.quadraticCurveTo(e+s,i,e+s,i+h),t.lineTo(e+s,i+a-h),t.quadraticCurveTo(e+s,i+a,e+s-h,i+a),t.lineTo(e+h,i+a),t.quadraticCurveTo(e,i+a,e,i+a-h),t.lineTo(e,i+h),t.quadraticCurveTo(e,i,e+h,i),t.closePath(),o&&t.fill(),r&&t.stroke()}function e(t,e){var i=parseInt(t.replace("#",""),16),s=Math.round(2.55*e),a=(i>>16)+s,h=(i>>8&255)+s,o=(255&i)+s;return"#"+(16777216+65536*(a<255?a<1?0:a:255)+256*(h<255?h<1?0:h:255)+(o<255?o<1?0:o:255)).toString(16).slice(1)}function i(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}function s(t){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s(t)}function a(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,h(s.key),s)}}function h(t){var e=function(t){if("object"!=s(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=s(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==s(e)?e:e+""}const o=function(){return i=function t(e,i){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.canvas=e,this.weapons=i,this.currentWeaponIndex=0,this.currentWeapon=i[0],this.x=100,this.y=e.height/2,this.width=60,this.height=40,this.speed=5,this.jumpPower=12,this.velY=0,this.health=100,this.maxHealth=100,this.isJumping=!1,this.isShooting=!1,this.direction=1,this.lastShot=0,this.standingOnObstacle=null,this.specialTokens=0,this.maxSpecialTokens=5,this.specialAbilityActive=!1,this.specialAbilityDuration=0,this.specialAbilityMaxDuration=300,this.specialAbilityConsumptionRate=100,this.specialAbilityLastConsumption=0,this.isLanding=!1,this.lastVelY=0,this.smashDamage=30,this.landingThreshold=3,this.legs=Array(6).fill().map((function(t,e){return{angle:60*e,length:15,phase:.5*e}})),this.mushroomPowerActive=!1,this.originalWidth=this.width,this.originalHeight=this.height,this.weaponDamageMultiplier=1,this.isGrowing=!1,this.growthStage=0,this.growthVisible=!0,this.growthAnimationFrame=0,this.isShrinking=!1,this.shrinkStage=0,this.shrinkVisible=!0,this.shrinkAnimationFrame=0},s=[{key:"update",value:function(t,e,i,s){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;this.lastVelY=this.velY,this.isGrowing&&this.updateGrowthAnimation(i),this.isShrinking&&this.updateShrinkAnimation(i),(t.ArrowLeft||t.a||t.A)&&(this.x-=this.speed*a,this.direction=-1),(t.ArrowRight||t.d||t.D)&&(this.x+=this.speed*a,this.direction=1),(t.z||t.ArrowUp||t.w||t.W)&&!this.isJumping&&(this.velY=-this.jumpPower,this.isJumping=!0,this.standingOnObstacle=null,i(this.x+this.width/2,this.y+this.height,10,"#777")),this.velY+=.5*a,this.y+=this.velY*a,this.y+this.height>this.canvas.height-50&&(this.y=this.canvas.height-50-this.height,this.velY=0,this.isJumping=!1),this.x<0&&(this.x=0),this.x+this.width>this.canvas.width&&(this.x=this.canvas.width-this.width),this.mushroomPowerActive&&this.updateGrowthAnimation(i),this.legs.forEach((function(t,i){t.angle=60*i+20*Math.sin(.1*e+t.phase)}))}},{key:"checkBoxSmash",value:function(t,e){var i=this;if(!this.standingOnObstacle)return!1;if("box"===this.standingOnObstacle.type&&(this.isLanding||this.lastVelY>=this.landingThreshold)){var s=this.mushroomPowerActive?2:1,a=this.standingOnObstacle.takeDamage(s),h=this.mushroomPowerActive||2===this.standingOnObstacle.jumpCount?25:15;if(e(this.standingOnObstacle.x+this.standingOnObstacle.width/2,this.standingOnObstacle.y,h,"#a67c52"),this.mushroomPowerActive||2===this.standingOnObstacle.jumpCount){this.velY=-4;for(var o=0;o<3;o++)setTimeout((function(){e(i.standingOnObstacle.x+Math.random()*i.standingOnObstacle.width,i.standingOnObstacle.y,10,"#a67c52")}),100*o)}else this.velY=-2;return a}return!1}},{key:"shoot",value:function(t,e,i,s){var a=this.weapons[this.currentWeaponIndex];if(t-this.lastShot>a.fireRate){var h=this.x+(this.direction>0?this.width:0),o=this.y+this.height/2-a.height/2,r=this.mushroomPowerActive?2:1,n="ROBOHORSE CANNON"===a.name;return e.push({x:h,y:o,width:a.width,height:a.height,speed:a.projectileSpeed,velX:a.projectileSpeed*this.direction,velY:0,damage:a.damage*r,color:a.color,isPlayerProjectile:!0,isGlowing:a.isGlowing||!1,isSineWave:n,sineAmplitude:n?4:0,sineFrequency:n?.05:0,sinePhase:.1*t,initialY:o}),i(h,o,5,a.color),s&&s(a.name),this.lastShot=t,!0}return!1}},{key:"specialAbility",value:function(t,e,i,s){if(this.specialTokens<=0&&!this.specialAbilityActive)return!1;if(!this.specialAbilityActive&&this.specialTokens>0&&(this.specialAbilityActive=!0,this.specialAbilityDuration=0,this.specialAbilityLastConsumption=t,this.specialTokens--,i(this.x+this.width/2,this.y+this.height/2,30,this.weapons[this.currentWeaponIndex].color)),this.specialAbilityActive){if(this.specialAbilityDuration++,t-this.specialAbilityLastConsumption>=this.specialAbilityConsumptionRate&&this.specialTokens>0&&(this.specialTokens--,this.specialAbilityLastConsumption=t,this.specialAbilityDuration=0),this.specialAbilityDuration>=this.specialAbilityMaxDuration&&this.specialTokens<=0)return this.specialAbilityActive=!1,!1;if(t%10==0){for(var a=this.weapons[this.currentWeaponIndex],h=0;h<5;h++){var o=-Math.PI/4+Math.PI/2*h/4;e.push({x:this.x+this.width/2,y:this.y+this.height/2,width:a.width,height:a.height,speed:a.projectileSpeed,velX:Math.cos(o)*a.projectileSpeed*this.direction,velY:Math.sin(o)*a.projectileSpeed,damage:a.damage/2,color:a.color,isPlayerProjectile:!0,isGlowing:a.isGlowing||!1})}i(this.x+this.width/2,this.y+this.height/2,10,this.weapons[this.currentWeaponIndex].color),s&&s(a.name)}return!0}return!1}},{key:"switchWeapon",value:function(){return this.currentWeaponIndex=(this.currentWeaponIndex+1)%this.weapons.length,this.currentWeapon=this.weapons[this.currentWeaponIndex],this.weapons[this.currentWeaponIndex].name}},{key:"draw",value:function(i,s,a){var h=this;i.save();var o=this.x+this.width/2,r=this.y+this.height/2;if(this.specialAbilityActive){var n=10+5*Math.sin(.1*s),l=this.weapons[this.currentWeaponIndex].color;i.fillStyle="rgba(".concat(parseInt(l.slice(1,3),16),", ").concat(parseInt(l.slice(3,5),16),", ").concat(parseInt(l.slice(5,7),16),", 0.3)"),i.beginPath(),i.ellipse(o,r,.7*this.width+n,.9*this.height+n,0,0,2*Math.PI),i.fill()}i.fillStyle="rgba(0, 0, 0, 0.3)",i.beginPath(),i.ellipse(o,this.canvas.height-50,.8*this.width,10,0,0,2*Math.PI),i.fill(),this.legs.forEach((function(t,e){var a=(t.angle,Math.PI,h.direction);a=e<2?((0===e?30:60)+10*Math.sin(.1*s+t.phase))*Math.PI/180*h.direction:e<4?((2===e?330:300)+10*Math.sin(.1*s+t.phase))*Math.PI/180*h.direction:((4===e?120:210)+10*Math.sin(.1*s+t.phase))*Math.PI/180*h.direction;var n=.6*t.length,l=o+Math.cos(a)*n,c=r+Math.sin(a)*n,d=l+Math.cos(a)*t.length,y=c+Math.sin(a)*t.length+3*Math.sin(.1*s+t.phase),u=i.createLinearGradient(o,r,l,c);u.addColorStop(0,"#0066aa"),u.addColorStop(1,"#00ccff"),i.strokeStyle=u,i.lineWidth=4,i.lineCap="round",i.beginPath(),i.moveTo(o,r),i.lineTo(l,c),i.stroke();var p=i.createLinearGradient(l,c,d,y);p.addColorStop(0,"#00ccff"),p.addColorStop(1,"#00ffff"),i.strokeStyle=p,i.beginPath(),i.moveTo(l,c),i.lineTo(d,y),i.stroke(),i.fillStyle="#00ffff",i.shadowColor="#00ffff",i.shadowBlur=5,i.beginPath(),i.arc(l,c,4,0,2*Math.PI),i.fill(),i.fillStyle="#00ffff",i.shadowColor="#00ffff",i.shadowBlur=10,i.beginPath(),h.direction>0?(i.moveTo(d-4,y),i.lineTo(d+4,y),i.lineTo(d+4,y+6),i.lineTo(d-4,y+6)):(i.moveTo(d+4,y),i.lineTo(d-4,y),i.lineTo(d-4,y+6),i.lineTo(d+4,y+6)),i.closePath(),i.fill(),i.shadowBlur=0}));var c=i.createLinearGradient(this.x,this.y,this.x+this.width,this.y+this.height);c.addColorStop(0,"#092344"),c.addColorStop(.5,"#1a5b9c"),c.addColorStop(1,"#092344"),i.fillStyle=c,i.strokeStyle="#0af",i.lineWidth=2,i.beginPath(),i.ellipse(o,r,.5*this.width,.7*this.height,0,0,2*Math.PI),i.fill(),i.stroke(),i.strokeStyle="rgba(0, 255, 255, 0.7)",i.lineWidth=1,i.beginPath(),i.moveTo(this.x+.2*this.width,r),i.lineTo(this.x+.8*this.width,r),i.stroke();for(var d=0;d<5;d++){var y=this.x+this.width*(.3+.1*d);i.beginPath(),i.moveTo(y,r-.3*this.height),i.lineTo(y,r+.3*this.height),i.stroke()}var u=i.createRadialGradient(o,r,2,o,r,10);u.addColorStop(0,"#fff"),u.addColorStop(.3,"#0ff"),u.addColorStop(1,"rgba(0, 255, 255, 0)"),i.fillStyle=u,i.beginPath(),i.arc(o,r,10,0,2*Math.PI),i.fill();var p=this.x+(this.direction>0?.8*this.width:.2*this.width),m=this.y,g=this.x+(this.direction>0?.7*this.width:.3*this.width),f=this.y+.3*this.height,v=i.createLinearGradient(g,f,p,m);v.addColorStop(0,"#1a5b9c"),v.addColorStop(1,"#092344"),i.fillStyle=v,i.beginPath(),i.moveTo(g,f),i.quadraticCurveTo(g+.1*(p-g),f-.4*this.height,p,m),i.lineTo(p+(this.direction>0?5:-5),m),i.quadraticCurveTo(g+.1*(p-g)+(this.direction>0?5:-5),f-.4*this.height,g+(this.direction>0?5:-5),f),i.closePath(),i.fill(),i.strokeStyle="#0af",i.stroke();for(var w=["#00ccff","#0066ff","#0033aa"],b=0;b<7;b++){this.height;var x=b/7,S=g+(p-g)*x,P=(1-x)*(1-x)*f+2*(1-x)*x*(f-.4*this.height)+x*x*m,M=10+3*Math.sin(.1*s+b),k=w[b%w.length];i.strokeStyle=k,i.lineWidth=2,i.shadowColor=k,i.shadowBlur=5,i.beginPath(),i.moveTo(S,P),i.lineTo(S+(this.direction>0?-M:M),P-.7*M),i.stroke(),i.fillStyle="#fff",i.beginPath(),i.arc(S+(this.direction>0?-M:M),P-.7*M,2,0,2*Math.PI),i.fill(),i.shadowBlur=0}var T=this.x+(this.direction>0?.2*this.width:.8*this.width),C=this.y+.3*this.height;i.fillStyle="#092344",i.beginPath(),i.moveTo(T,C),i.quadraticCurveTo(T+(this.direction>0?-20:20),C+15,T+(this.direction>0?-30:30),C+40),i.lineTo(T+(this.direction>0?-35:35),C+40),i.quadraticCurveTo(T+(this.direction>0?-25:25),C+15,T,C+5),i.closePath(),i.fill(),i.strokeStyle="#0af",i.stroke();for(var E=0;E<5;E++){var I=.05*s+.5*E,A=T+(this.direction>0?-30:30)+5*Math.sin(I),O=C+40,L=15+3*E;i.strokeStyle="#00ccff",i.shadowColor="#00ccff",i.shadowBlur=5,i.lineWidth=2,i.beginPath(),i.moveTo(A,O),i.quadraticCurveTo(A+(this.direction>0?-10:10),O+.6*L,A+(this.direction>0?-5:5),O+L),i.stroke(),i.fillStyle="#fff",i.beginPath(),i.arc(A+(this.direction>0?-5:5),O+L,2,0,2*Math.PI),i.fill(),i.shadowBlur=0}var B=.4*this.width,R=.6*this.height,D=p+(this.direction>0?0:-B),j=m-.7*R,_=i.createLinearGradient(D,j,D+B,j+R);_.addColorStop(0,"#656565"),_.addColorStop(.5,"#a9a9a9"),_.addColorStop(1,"#656565"),i.fillStyle=_,i.strokeStyle="#0af",i.lineWidth=2,i.beginPath(),i.moveTo(D,j+.3*R),i.quadraticCurveTo(D+.5*B,j-.1*R,D+B,j+.3*R),this.direction>0?(i.lineTo(D+B,j+.8*R),i.quadraticCurveTo(D+.8*B,j+.9*R,D+.6*B,j+R),i.lineTo(D+.2*B,j+R),i.quadraticCurveTo(D+.1*B,j+.7*R,D,j+.5*R)):(i.lineTo(D,j+.8*R),i.quadraticCurveTo(D+.2*B,j+.9*R,D+.4*B,j+R),i.lineTo(D+.8*B,j+R),i.quadraticCurveTo(D+.9*B,j+.7*R,D+B,j+.5*R)),i.closePath(),i.fill(),i.stroke(),i.fillStyle="#222";var N=j+.4*R,G=.15*R;t(i,D+.2*B,N,.6*B,G,3,!0,!1);var F=D+B*(this.direction,.5),W=N+.5*G,H=.4*B,Y=.6*G;i.fillStyle="#f00",i.shadowColor="#f00",i.shadowBlur=15,i.beginPath(),i.rect(F-.5*H,W-.5*Y,H,Y),i.fill();var U=F-.5*H+H*(s%60/60);i.fillStyle="#fff",i.beginPath(),i.rect(U-1,W-.5*Y,2,Y),i.fill(),i.shadowBlur=0;var z=.15*B,q=.3*R;i.fillStyle="#555",i.beginPath(),i.moveTo(D+.25*B,j+.1*R),i.lineTo(D+.2*B-z,j-q),i.lineTo(D+.3*B-z,j-.7*q),i.closePath(),i.fill(),i.strokeStyle="#0af",i.stroke(),i.beginPath(),i.moveTo(D+.75*B,j+.1*R),i.lineTo(D+.8*B+z,j-q),i.lineTo(D+.7*B+z,j-.7*q),i.closePath(),i.fill(),i.stroke();var K=j+.9*R,X=D+B*(this.direction>0?.25:.75),V=D+B*(this.direction>0?.35:.65);i.fillStyle="#0ff",i.shadowColor="#0ff",i.shadowBlur=5,i.beginPath(),i.arc(X,K,2,0,2*Math.PI),i.fill(),i.beginPath(),i.arc(V,K,2,0,2*Math.PI),i.fill(),i.shadowBlur=0;var $,J=this.weapons[this.currentWeaponIndex],Z=this.y+.3*this.height;if($=this.direction>0?this.x+.8*this.width:this.x+.2*this.width-25,J.isGlowing){i.save();var Q=$+(this.direction>0?25:0),tt=Z+4,et=i.createRadialGradient(Q,tt,0,Q,tt,12);et.addColorStop(0,"#ffffff"),et.addColorStop(.5,"#cccccc"),et.addColorStop(1,"rgba(200, 200, 200, 0)"),i.shadowColor="#ffffff",i.shadowBlur=15,i.fillStyle="#aaaaaa",this.direction>0?t(i,$,Z,19,8,3,!0,!1):t(i,$+6,Z,19,8,3,!0,!1),i.fillStyle=et,i.beginPath(),i.arc(Q,tt,6,0,2*Math.PI),i.fill(),i.restore()}else{var it=i.createLinearGradient($,Z,$+25,Z);it.addColorStop(0,J.color),it.addColorStop(1,e(J.color,30)),i.fillStyle=it,i.shadowColor=J.color,i.shadowBlur=10,t(i,$,Z,25,8,3,!0,!1),i.fillStyle=e(J.color,50),this.direction>0?t(i,$+25-5,Z+1,3,6,1,!0,!1):t(i,$+2,Z+1,3,6,1,!0,!1)}if(i.shadowBlur=0,a.ArrowLeft||a.ArrowRight||a.a||a.A||a.d||a.D)for(var st=this.x+(this.direction>0?.2*this.width:.8*this.width),at=this.y+.7*this.height,ht=0;ht<5;ht++){var ot=5*Math.random()+3,rt=-this.direction*(20*Math.random()+5),nt=8*Math.random()-4,lt=i.createRadialGradient(st,at,0,st,at,2*ot);lt.addColorStop(0,"#fff"),lt.addColorStop(.2,"#0af"),lt.addColorStop(1,"rgba(0, 170, 255, 0)"),i.fillStyle=lt,i.beginPath(),i.arc(st+rt,at+nt,ot,0,2*Math.PI),i.fill()}i.restore()}},{key:"activateMushroomPower",value:function(t,e){return!this.mushroomPowerActive&&!this.isGrowing&&(this.originalWidth=this.width,this.originalHeight=this.height,t(this.x+this.width/4,this.y+this.height/4,30,"#ff0000"),e&&e(),this.isGrowing=!0,this.growthStage=0,this.growthAnimationFrame=0,!0)}},{key:"updateGrowthAnimation",value:function(t){if(this.isGrowing&&(this.growthAnimationFrame++,this.growthAnimationFrame%5==0)){var e=Math.min(this.growthAnimationFrame/30,1);this.width=this.originalWidth*(1+e),this.height=this.originalHeight*(1+1.5*e),this.y+this.height>this.canvas.height-50&&(this.y=this.canvas.height-50-this.height),this.growthAnimationFrame%10==0&&t(this.x+this.width/2,this.y+this.height/2,10,"#ff0000"),this.growthAnimationFrame>=30&&(this.isGrowing=!1,this.mushroomPowerActive=!0,this.width=2*this.originalWidth,this.height=2.5*this.originalHeight,this.y+this.height>this.canvas.height-50&&(this.y=this.canvas.height-50-this.height),t(this.x+this.width/2,this.y+this.height/2,30,"#ff0000"))}}},{key:"deactivateMushroomPower",value:function(t){this.mushroomPowerActive=!1,this.mushroomPowerTimer=0,this.width=60,this.height=40,this.speed=5,this.jumpPower=12,this.isShrinking=!0,this.growthScale=1,t&&t(this.x+this.width/2,this.y+this.height/2,20,"#8B4513")}},{key:"updateShrinkAnimation",value:function(t){this.isShrinking&&(this.shrinkScale=Math.max(1,this.shrinkScale-.05),this.shrinkScale<=1&&(this.isShrinking=!1,this.shrinkScale=1),t&&Math.random()<.3&&t(this.x+Math.random()*this.width,this.y+Math.random()*this.height,1,"#8B4513"))}},{key:"reset",value:function(){this.x=100,this.y=this.canvas.height/2,this.velY=0,this.isJumping=!1,this.direction=1,this.health=100,this.currentWeaponIndex=0,this.currentWeapon=this.weapons[0],this.lastShot=0,this.specialTokens=0,this.specialAbilityActive=!1,this.specialAbilityDuration=0,this.specialAbilityLastConsumption=0,this.mushroomPowerActive=!1,this.mushroomPowerTimer=0,this.isGrowing=!1,this.isShrinking=!1,this.growthScale=1,this.shrinkScale=1,this.standingOnObstacle=null,this.isLanding=!1,this.lastVelY=0}}],s&&a(i.prototype,s),Object.defineProperty(i,"prototype",{writable:!1}),i;var i,s}();function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}function n(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,l(s.key),s)}}function l(t){var e=function(t){if("object"!=r(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=r(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==r(e)?e:e+""}const c=function(){return i=function t(e,i,s,a){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.canvas=a,this.x=e,this.y=i,this.width=s.width,this.height=s.height,this.velX=0,this.velY=0,this.speed=s.speed,this.health=s.health,this.maxHealth=s.maxHealth,this.points=s.points,this.color=s.color,this.tentacles=Array(s.tentacles||8).fill().map((function(t,e){return{angle:e/(s.tentacles||8)*Math.PI*2,speed:.02+.01*Math.random(),phase:Math.random()*Math.PI*2}})),this.damageFeedbackTimer=0,this.damageFeedbackDuration=10,this.aggressionFactor=1.5+.5*Math.random(),this.curiosityRadius=300,this.orbitSpeed=.02,this.orbitAngle=Math.random()*Math.PI*2,this.behaviorState="curious",this.stateSwitchTimer=0,this.stateSwitchInterval=120,this.targetOffsetX=80*(Math.random()-.5),this.targetOffsetY=80*(Math.random()-.5),this.scrollCompensation=.8,this.spawnTimer=30,this.movementUpdateFrequency=10,console.log("Enhanced enemy created at",e,i,"with health",this.health,"and aggression",this.aggressionFactor)},s=[{key:"update",value:function(t,e,i){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if(this.spawnTimer>0)return this.spawnTimer--,this.x-=this.scrollCompensation*(1-this.spawnTimer/30)*s,null;if(this.directionChangeTimer>0&&this.directionChangeTimer--,e%this.movementUpdateFrequency==0){e%90==0&&(this.targetOffsetX=80*(Math.random()-.5),this.targetOffsetY=80*(Math.random()-.5));var a=t.x+this.targetOffsetX,h=t.y+this.targetOffsetY,o=a-this.x,r=h-this.y,n=Math.sqrt(o*o+r*r);if(this.stateSwitchTimer<=0?(n<this.curiosityRadius?this.behaviorState=Math.random()<.7?"curious":"aggressive":this.behaviorState="curious",this.stateSwitchTimer=this.stateSwitchInterval):this.stateSwitchTimer--,0===this.directionChangeTimer||n>200){if("curious"===this.behaviorState){this.orbitAngle+=this.orbitSpeed*s;var l=Math.min(n,.7*this.curiosityRadius),c=a+Math.cos(this.orbitAngle)*l,d=h+Math.sin(this.orbitAngle)*l,y=c-this.x,u=d-this.y,p=Math.sqrt(y*y+u*u);p>0&&(this.velX=y/p*this.speed*s,this.velY=u/p*this.speed*s)}else n>0&&(this.velX=o/n*this.speed*this.aggressionFactor*s,this.velY=r/n*this.speed*this.aggressionFactor*s);this.directionChangeTimer=this.maxDirectionChangeTime}if(e%30==0&&Math.random()<.3){var m=(Math.random()-.5)*Math.PI/10,g=Math.atan2(r,o)+m;n>0&&(this.velX=Math.cos(g)*this.speed*this.aggressionFactor+this.scrollCompensation,this.velY=Math.sin(g)*this.speed*this.aggressionFactor),i(this.x+this.width/2,this.y+this.height/2,2,this.color)}var f=.9;this.x<-50&&(this.velX=Math.abs(this.velX)*f,this.x=-50),this.x>this.canvas.width+50&&(this.velX=-Math.abs(this.velX)*f,this.x=this.canvas.width+50),this.y<0&&(this.velY=Math.abs(this.velY)*f,this.y=0);var v=this.canvas.height-50;if(this.y+this.height>v+20&&(this.velY=-Math.abs(this.velY)*f,this.y=v+20-this.height),n>this.canvas.width/4?(this.x+=1.2*this.velX,this.y+=1.2*this.velY):(this.x+=this.velX,this.y+=this.velY),Math.abs(this.velX)<.5&&Math.abs(this.velY)<.5){var w=Math.random()*Math.PI*2;this.velX=Math.cos(w)*this.speed*.8+this.scrollCompensation,this.velY=Math.sin(w)*this.speed*.8}}else this.x+=this.velX,this.y+=this.velY;if(Math.sqrt(Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2))<300&&e%120==0&&Math.random()<.3){var b=t.x-this.x,x=t.y-this.y,S=Math.sqrt(b*b+x*x);return{x:this.x+this.width/2,y:this.y+this.height/2,width:5,height:5,speed:5,velX:b/S*5,velY:x/S*5,damage:5,color:this.color,isPlayerProjectile:!1}}return this.x+=this.velX-this.scrollCompensation*s,this.y+=this.velY,this.y<0&&(this.y=0),this.y+this.height>this.canvas.height-50&&(this.y=this.canvas.height-50-this.height),this.damageFeedbackTimer>0&&this.damageFeedbackTimer--,this.tentacles&&this.tentacles.forEach((function(t){t.angle+=t.speed*s})),null}},{key:"takeDamage",value:function(t){return this.health-=t,this.damageFeedbackTimer=this.damageFeedbackDuration,this.health<=0}},{key:"draw",value:function(i,s,a){var h=this,o=this.color;this.damageFeedbackTimer>0&&(this.damageFeedbackTimer--,this.color=this.damageFeedbackTimer%2==0?"#ff3333":"#ffffff"),i.save(),i.fillStyle="rgba(0, 0, 0, 0.3)",i.beginPath(),i.ellipse(this.x+this.width/2,this.y+this.height+5,this.width/2,5,0,0,2*Math.PI),i.fill();var r=i.createRadialGradient(this.x+this.width/2,this.y+this.height/2,0,this.x+this.width/2,this.y+this.height/2,this.width/2),n=this.color,l=e(n,30),c=e(n,-20);r.addColorStop(0,l),r.addColorStop(.7,n),r.addColorStop(1,c),i.fillStyle=r,i.beginPath(),i.ellipse(this.x+this.width/2,this.y+this.height/2-5,this.width/2,this.height/2*.8,0,0,2*Math.PI),i.fill(),i.strokeStyle=e(n,10),i.lineWidth=1;for(var d=1;d<=3;d++)i.beginPath(),i.ellipse(this.x+this.width/2,this.y+this.height/2-5,this.width/2*(d/3),this.height/2*.8*(d/3),0,0,2*Math.PI),i.stroke();var y=this.width/5,u=this.width/10+2,p=this.y+this.height/2-this.height/6;i.shadowColor="#f00",i.shadowBlur=10;var m=i.createRadialGradient(this.x+this.width/2-y,p,0,this.x+this.width/2-y,p,u);m.addColorStop(0,"#fff"),m.addColorStop(.6,"#f88"),m.addColorStop(1,"#f00"),i.fillStyle=m,i.beginPath(),i.arc(this.x+this.width/2-y,p,u,0,2*Math.PI),i.fill();var g=i.createRadialGradient(this.x+this.width/2+y,p,0,this.x+this.width/2+y,p,u);g.addColorStop(0,"#fff"),g.addColorStop(.6,"#f88"),g.addColorStop(1,"#f00"),i.fillStyle=g,i.beginPath(),i.arc(this.x+this.width/2+y,p,u,0,2*Math.PI),i.fill();var f=Math.atan2(a.y-this.y,a.x-this.x),v=.4*u;i.shadowBlur=0,i.fillStyle="#000";var w=this.x+this.width/2-y+Math.cos(f)*v,b=p+Math.sin(f)*v;i.beginPath(),i.arc(w,b,.4*u,0,2*Math.PI),i.fill();var x=this.x+this.width/2+y+Math.cos(f)*v,S=p+Math.sin(f)*v;i.beginPath(),i.arc(x,S,.4*u,0,2*Math.PI),i.fill(),i.lineWidth=3,i.lineCap="round",this.tentacles.forEach((function(t,a){var o=t.angle+.3*Math.sin(s*t.speed),r=.1*s+t.phase,l=i.createLinearGradient(h.x+h.width/2,h.y+h.height/2,h.x+h.width/2+Math.cos(o)*h.width,h.y+h.height/2+Math.sin(o)*h.height);l.addColorStop(0,n),l.addColorStop(1,e(n,-10)),i.strokeStyle=l,i.beginPath(),i.moveTo(h.x+h.width/2,h.y+h.height/2);var c=h.x+h.width/2+Math.cos(o)*h.width/2,d=h.y+h.height/2+Math.sin(o)*h.height/2,y=h.x+h.width/2+Math.cos(o+.3*Math.sin(r))*h.width*.8,u=h.y+h.height/2+Math.sin(o+.3*Math.sin(r))*h.height*.8,p=h.x+h.width/2+Math.cos(o+.5*Math.sin(r))*h.width,m=h.y+h.height/2+Math.sin(o+.5*Math.sin(r))*h.height;if(i.bezierCurveTo(c,d,y,u,p,m),i.stroke(),a%2==0){i.fillStyle=e(n,20);for(var g=.3;g<=.9;g+=.2){var f=g,v=Math.pow(1-f,3)*(h.x+h.width/2)+3*Math.pow(1-f,2)*f*c+3*(1-f)*Math.pow(f,2)*y+Math.pow(f,3)*p,w=Math.pow(1-f,3)*(h.y+h.height/2)+3*Math.pow(1-f,2)*f*d+3*(1-f)*Math.pow(f,2)*u+Math.pow(f,3)*m;i.beginPath(),i.arc(v,w,2,0,2*Math.PI),i.fill()}}}));var P=this.health/this.maxHealth;i.fillStyle="rgba(0, 0, 0, 0.7)",t(i,this.x,this.y-15,this.width,7,3,!0,!1);var M="#0f0";P<=.5&&P>.25?M="#ff0":P<=.25&&(M="#f00",i.shadowColor="#f00",i.shadowBlur=8),i.fillStyle=M,t(i,this.x,this.y-15,this.width*P,7,3,!0,!1),i.shadowBlur=0,this.color=o,i.restore()}}],s&&n(i.prototype,s),Object.defineProperty(i,"prototype",{writable:!1}),i;var i,s}();function d(t){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d(t)}function y(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,u(s.key),s)}}function u(t){var e=function(t){if("object"!=d(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=d(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==d(e)?e:e+""}const p=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.canvas=e,this.ctx=e.getContext("2d"),this.moonSize=80,this.moonX=-this.moonSize,this.moonY=100,this.moonSpeed=.05},(e=[{key:"draw",value:function(t,e){var i=t.createLinearGradient(0,0,0,this.canvas.height);i.addColorStop(0,"#0c0121"),i.addColorStop(.5,"#1a0a35"),i.addColorStop(1,"#0d1e38"),t.fillStyle=i,t.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawMoon(t,e);for(var s=0;s<150;s++){var a=(23*s+.01*e)%this.canvas.width,h=17*s%(.5*this.canvas.height),o=1.5*(Math.sin(.005*e+s)+1),r=["#fff","#0ff","#f0f","#ff0","#f77"],n=s%r.length;t.fillStyle=r[n],t.shadowColor=r[n],t.shadowBlur=5,t.beginPath(),t.arc(a,h,o,0,2*Math.PI),t.fill(),t.shadowBlur=0}for(var l=["#090918","#0d0d2b","#09132b"],c=this.canvas.width/20,d=0;d<20;d++){var y=d*c-.1*e%c,u=60+30*Math.sin(d),p=d%l.length;t.fillStyle=l[p],t.beginPath(),t.rect(y,this.canvas.height-50-u,c,u),t.fill(),t.fillStyle="rgba(255, 255, 150, 0.3)";for(var m=0;m<10;m++){var g=y+Math.random()*c,f=this.canvas.height-50-Math.random()*u,v=1+Math.random();t.beginPath(),t.rect(g,f,v,v),t.fill()}}for(var w=["#131339","#16083a","#080a20"],b=this.canvas.width/15*1.5,x=0;x<15;x++){var S=x*b-.3*e%(15*b),P=100+40*Math.sin(.8*x),M=b-10,k=x%w.length;t.fillStyle=w[k],t.beginPath(),t.moveTo(S,this.canvas.height-50),t.lineTo(S,this.canvas.height-50-P),x%3==0?(t.lineTo(S+M/2-10,this.canvas.height-50-P),t.lineTo(S+M/2,this.canvas.height-50-P-20),t.lineTo(S+M/2+10,this.canvas.height-50-P)):t.lineTo(S+M,this.canvas.height-50-P),t.lineTo(S+M,this.canvas.height-50),t.closePath(),t.fill();for(var T=M/6,C=P/11,E=1;E<=10;E++)for(var I=1;I<=5;I++)if(Math.random()>.3){var A=S+I*T,O=this.canvas.height-50-E*C,L=["rgba(255, 255, 150, 0.7)","rgba(150, 255, 255, 0.7)","rgba(255, 150, 255, 0.7)"],B=L[Math.floor(Math.random()*L.length)];t.fillStyle=B,t.shadowColor=B,t.shadowBlur=3,t.beginPath(),t.rect(A,O,4,6),t.fill(),t.shadowBlur=0}}for(var R=this.canvas.width/8*1.5,D=0;D<8;D++){var j=D*R-.5*e%(8*R),_=150+40*Math.sin(.5*D),N=R-20;if(t.fillStyle="#000",t.beginPath(),t.rect(j,this.canvas.height-50-_,N,_),t.fill(),D%2==0){var G=.7*N,F=j+(N-G)/2,W=this.canvas.height-50-.7*_,H=["#f00","#0ff","#f0f","#ff0","#0f0"],Y=H[D%H.length];t.shadowColor=Y,t.shadowBlur=15,t.strokeStyle=Y,t.lineWidth=2,t.strokeRect(F,W,G,30),t.font="20px Arial",t.fillStyle=Y,t.textAlign="center",t.fillText("東京",F+G/2,W+21),t.shadowBlur=0}for(var U=Math.floor(N/10),z=0;z<15;z++)for(var q=0;q<U;q++)if(Math.random()>.4){var K=j+10*q+2,X=this.canvas.height-50-_+10*z+2,V=["rgba(255, 255, 150, 0.8)","rgba(150, 255, 255, 0.8)","rgba(255, 150, 255, 0.8)"],$=V[Math.floor(Math.random()*V.length)];t.fillStyle=$,t.beginPath(),t.rect(K,X,6,6),t.fill()}D%3==0&&(t.strokeStyle="#555",t.lineWidth=3,t.beginPath(),t.moveTo(j+N/2,this.canvas.height-50-_),t.lineTo(j+N/2,this.canvas.height-50-_-30),t.stroke(),e%30<15&&(t.fillStyle="#f00",t.shadowColor="#f00",t.shadowBlur=10,t.beginPath(),t.arc(j+N/2,this.canvas.height-50-_-30,3,0,2*Math.PI),t.fill(),t.shadowBlur=0))}var J=100+.5*e%(2*this.canvas.width),Z=this.canvas.height-50-180;if(t.fillStyle="#111",t.strokeStyle="#555",t.lineWidth=3,t.fillRect(J,Z,120,70),t.strokeRect(J,Z,120,70),t.fillStyle="#0af",t.shadowColor="#0af",t.shadowBlur=10,e%120<60)t.font="20px Arial",t.textAlign="center",t.fillText("CYBER",J+60,Z+30),t.fillText("TOKYO",J+60,Z+55);else for(var Q=0;Q<5;Q++)t.beginPath(),t.arc(J+60,Z+35,10+5*Q,0,2*Math.PI),t.stroke();t.shadowBlur=0;for(var tt=0;tt<5;tt++){var et=(150*tt+2*e)%(this.canvas.width+300)-100,it=100+30*tt,st=4+tt;t.fillStyle="#222",t.fillRect(et,it,3*st,st),t.fillStyle="#f00",t.shadowColor="#f00",t.shadowBlur=10,t.beginPath(),t.arc(et+3*st,it+st/2,st/3,0,2*Math.PI),t.fill(),t.fillStyle="#ff0",t.shadowColor="#ff0",t.beginPath(),t.arc(et,it+st/2,st/3,0,2*Math.PI),t.fill(),t.shadowBlur=0}var at=t.createLinearGradient(0,this.canvas.height-50,0,this.canvas.height);at.addColorStop(0,"#0a0a20"),at.addColorStop(1,"#000000"),t.fillStyle=at,t.fillRect(0,this.canvas.height-50,this.canvas.width,50),t.globalAlpha=.2,t.translate(0,this.canvas.height-50),t.scale(1,-.3),t.drawImage(this.canvas,0,this.canvas.height-150,this.canvas.width,100,0,-100,this.canvas.width,100),t.setTransform(1,0,0,1,0,0),t.globalAlpha=1,t.strokeStyle="#0ff",t.shadowColor="#0ff",t.shadowBlur=10,t.lineWidth=2;for(var ht=0;ht<this.canvas.width;ht+=150){var ot=(ht+e)%this.canvas.width;t.beginPath(),t.moveTo(ot,this.canvas.height-48),t.lineTo(ot+80,this.canvas.height-48),t.stroke()}if(t.shadowBlur=0,e%100<50&&Math.random()>.98){var rt=Math.random()*this.canvas.width;t.fillStyle="rgba(255, 0, 255, 0.1)",t.beginPath(),t.moveTo(rt-20,0),t.lineTo(rt+20,0),t.lineTo(rt+5,this.canvas.height-50),t.lineTo(rt-5,this.canvas.height-50),t.closePath(),t.fill()}}},{key:"drawMoon",value:function(t,e){var i=this;this.moonX+=this.moonSpeed,this.moonX>this.canvas.width+this.moonSize&&(this.moonX=-this.moonSize);var s=5*Math.sin(.001*e),a=this.moonY+s;if(this.moonX+this.moonSize>0){var h=Math.max(0,this.moonX),o=Math.min(this.moonSize,this.moonX+this.moonSize),r=t.createRadialGradient(h,a,0,h,a,o);r.addColorStop(0,"#fffce8"),r.addColorStop(.8,"#fff9d6"),r.addColorStop(1,"#e6e0c0"),t.shadowColor="#fffce8",t.shadowBlur=30,t.fillStyle=r,t.beginPath(),t.arc(this.moonX,a,this.moonSize,0,2*Math.PI),t.fill(),t.shadowBlur=0,t.fillStyle="rgba(200, 200, 180, 0.2)",[{x:-.2,y:-.3,size:.15},{x:.3,y:.1,size:.1},{x:-.1,y:.25,size:.08},{x:.15,y:-.15,size:.12},{x:-.25,y:.05,size:.07}].forEach((function(e){var s=i.moonX+e.x*i.moonSize,h=a+e.y*i.moonSize,o=e.size*i.moonSize;t.beginPath(),t.arc(s,h,o,0,2*Math.PI),t.fill()}))}}}])&&y(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function m(t){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},m(t)}function g(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return f(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?f(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var s=0,a=function(){};return{s:a,n:function(){return s>=t.length?{done:!0}:{done:!1,value:t[s++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var h,o=!0,r=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return o=t.done,t},e:function(t){r=!0,h=t},f:function(){try{o||null==i.return||i.return()}finally{if(r)throw h}}}}function f(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,s=Array(e);i<e;i++)s[i]=t[i];return s}function v(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,w(s.key),s)}}function w(t){var e=function(t){if("object"!=m(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=m(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==m(e)?e:e+""}const b=function(){return t=function t(e,i,s,a){switch(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.x=e,this.y=i,this.type=s||"generic",this.canvas=a,this.type){case"car":this.width=180,this.height=80;var h=["#3366cc","#cc3333","#33cc33","#9933cc","#cc9933","#3399cc","#663399","#996633","#339966"];this.color=h[Math.floor(Math.random()*h.length)],this.points=100,this.health=1/0,this.carModel=Math.floor(4*Math.random()),this.hasMetallicPaint=Math.random()>.5;this.licensePlate="";for(var o=0;o<3;o++)this.licensePlate+="ABCDEFGHJKLMNPQRSTUVWXYZ".charAt(Math.floor(24*Math.random()));this.licensePlate+="-";for(var r=0;r<3;r++)this.licensePlate+="0123456789".charAt(Math.floor(10*Math.random()));this.canExplode=!0,this.isExploding=!1,this.explosionRadius=350,this.explosionDamage=100,this.explosionDuration=90,this.explosionTimer=0,this.explosionParticles=[],this.explosionHitEnemies=new Set,this.explosionTriggerCount=0,this.explosionTriggerThreshold=5,this.damageVisuals=[];break;case"cybertruck":this.width=200,this.height=100,this.color="#c0c0c0",this.points=250,this.health=1/0,this.hasNeonLights=!0,this.neonColor="#0ff",this.wheelGlow=!0;this.licensePlate="CYBER-";for(var n=0;n<3;n++)this.licensePlate+="0123456789".charAt(Math.floor(10*Math.random()));this.canExplode=!0,this.isExploding=!1,this.explosionRadius=450,this.explosionDamage=150,this.explosionDuration=120,this.explosionTimer=0,this.explosionParticles=[],this.explosionHitEnemies=new Set,this.explosionTriggerCount=0,this.explosionTriggerThreshold=10,this.damageVisuals=[];break;case"box":this.width=40,this.height=40,this.color="#a67c52",this.points=50,this.health=2,this.maxHealth=2,this.isBeingSmashed=!1,this.smashEffectCounter=0,this.smashEffectDuration=15,this.compressionAmount=0,this.cracks=[],this.jumpCount=0,this.woodGrainColor="#8d6a4b",this.containsMushroom=Math.random()<.3,this.containsMushroom&&(this.color="#b67c52",this.woodGrainColor="#9d6a4b",this.hasRedDot=!0);break;default:this.width=50,this.height=50,this.color="#888",this.points=10,this.health=30,this.maxHealth=30}this.y=a.height-50-this.height},(e=[{key:"update",value:function(){if(this.isBeingSmashed&&(this.smashEffectCounter--,"box"===this.type&&(this.compressionAmount=this.smashEffectCounter/this.smashEffectDuration*12),this.smashEffectCounter<=0&&(this.isBeingSmashed=!1,this.compressionAmount=0)),this.isExploding){this.explosionTimer++;for(var t=Math.min(this.explosionParticles.length,50),e=0;e<t;e++){var i=this.explosionParticles.length-1-e;if(i<0)break;var s=this.explosionParticles[i];s.x+=s.velX,s.y+=s.velY,"debris"===s.type&&s.gravity&&(s.velY+=s.gravity),"smoke"===s.type&&s.alpha&&(s.alpha-=s.fadeRate,s.alpha<0&&(s.alpha=0)),s.life--,s.life<=0&&this.explosionParticles.splice(i,1)}this.explosionTimer>=this.explosionDuration&&(this.isExploding=!1,this.explosionParticles=[],this.explosionHitEnemies.clear(),this.explosionRadius=0)}}},{key:"takeDamage",value:function(t){if(this.health!==1/0){if("box"===this.type){if(this.health-=1,this.jumpCount+=1,this.isBeingSmashed=!0,this.smashEffectCounter=this.smashEffectDuration,this.compressionAmount=12,1===this.jumpCount){for(var e=3+Math.floor(2*Math.random()),i=0;i<e;i++)this.cracks.push({x1:Math.random()*this.width,y1:Math.random()*this.height,x2:Math.random()*this.width,y2:Math.random()*this.height,width:1+2*Math.random()});this.woodGrainColor=this.containsMushroom?"#8d5a3b":"#7d5a3b"}else if(2===this.jumpCount){for(var s=4+Math.floor(3*Math.random()),a=0;a<s;a++)this.cracks.push({x1:Math.random()*this.width,y1:Math.random()*this.height,x2:Math.random()*this.width,y2:Math.random()*this.height,width:1+2*Math.random()});this.woodGrainColor=this.containsMushroom?"#6d3a1b":"#5d3a1b"}}else this.health-=t;return this.health<=0}return!("car"!==this.type&&"cybertruck"!==this.type||!this.canExplode||(this.explosionTriggerCount++,this.addDamageVisual(),!(this.explosionTriggerCount>=this.explosionTriggerThreshold)))&&this.explode()}},{key:"addDamageVisual",value:function(){var t=Math.random()*this.width,e=Math.random()*this.height,i=3+7*Math.random();this.damageVisuals.push({x:t,y:e,size:i,color:"#333333"})}},{key:"draw",value:function(t,e){var i=this;if(this.isExploding)this.drawExplosion(t);else{switch(this.type){case"car":switch(this.carModel){case 0:this.drawSedan(t,e);break;case 1:this.drawSUV(t,e);break;case 2:this.drawSportsCar(t,e);break;case 3:this.drawPickupTruck(t,e)}if(this.drawDamageVisuals(t),this.explosionTriggerCount>0&&!this.isExploding){t.fillStyle="rgba(255, 0, 0, 0.7)",t.font="14px Arial",t.textAlign="center";var s=this.explosionTriggerThreshold-this.explosionTriggerCount;t.fillText("".concat(s," more hit").concat(1!==s?"s":""," to explode!"),this.x+this.width/2,this.y-10)}break;case"cybertruck":if(this.drawCybertruck(t,e),this.drawDamageVisuals(t),this.explosionTriggerCount>0&&!this.isExploding){t.fillStyle="rgba(255, 0, 0, 0.7)",t.font="14px Arial",t.textAlign="center";var a=this.explosionTriggerThreshold-this.explosionTriggerCount;t.fillText("".concat(a," more hit").concat(1!==a?"s":""," to explode!"),this.x+this.width/2,this.y-10)}break;case"box":var h=this.isBeingSmashed?this.height-this.compressionAmount:this.height,o=this.isBeingSmashed?this.compressionAmount:0;t.fillStyle=this.color,t.fillRect(this.x,this.y+o,this.width,h),t.strokeStyle="#7d5a3b",t.lineWidth=2,t.strokeRect(this.x,this.y+o,this.width,h),this.cracks.length>0&&(t.strokeStyle="#5d3a1b",t.lineWidth=1,this.cracks.forEach((function(e){t.beginPath(),t.moveTo(i.x+e.x1,i.y+o+e.y1),t.lineTo(i.x+e.x2,i.y+o+e.y2),t.stroke()}))),t.strokeStyle=this.woodGrainColor,t.lineWidth=1;for(var r=0;r<3;r++){var n=this.y+o+h/4*(r+1);t.beginPath(),t.moveTo(this.x,n),t.lineTo(this.x+this.width,n),t.stroke()}this.containsMushroom&&this.hasRedDot&&(t.fillStyle="#ff0000",t.beginPath(),t.arc(this.x+this.width/2,this.y+o-5,3,0,2*Math.PI),t.fill(),t.shadowColor="#ff0000",t.shadowBlur=5,t.fill(),t.shadowBlur=0),1===this.jumpCount&&(t.fillStyle="rgba(255, 255, 255, 0.8)",t.font="10px Arial",t.textAlign="center",t.fillText("1 more!",this.x+this.width/2,this.y-15),t.shadowColor="#fff",t.shadowBlur=5,t.fillText("1 more!",this.x+this.width/2,this.y-15),t.shadowBlur=0);break;default:t.fillStyle=this.color,t.fillRect(this.x,this.y,this.width,this.height)}if(this.health!==1/0&&this.health<this.maxHealth){var l=this.health/this.maxHealth,c=.8*this.width;t.fillStyle="#555",t.fillRect(this.x+(this.width-c)/2,this.y-10,c,5),t.fillStyle=l>.5?"#0f0":l>.25?"#ff0":"#f00",t.fillRect(this.x+(this.width-c)/2,this.y-10,c*l,5)}}}},{key:"drawSedan",value:function(t,e){t.save();var i=this.color;if(this.hasMetallicPaint){var s=t.createLinearGradient(this.x,this.y,this.x,this.y+this.height);s.addColorStop(0,this.color),s.addColorStop(.5,this.lightenColor(this.color,30)),s.addColorStop(1,this.color),i=s}t.fillStyle=i,t.beginPath(),t.moveTo(this.x,this.y+.7*this.height),t.lineTo(this.x,this.y+.3*this.height),t.lineTo(this.x+.15*this.width,this.y+.2*this.height),t.lineTo(this.x+.85*this.width,this.y+.2*this.height),t.lineTo(this.x+this.width,this.y+.3*this.height),t.lineTo(this.x+this.width,this.y+.7*this.height),t.closePath(),t.fill(),t.strokeStyle=this.darkenColor(this.color,20),t.lineWidth=1,t.stroke(),this.drawCarDetails(t,e),t.restore()}},{key:"drawSUV",value:function(t,e){t.save();var i=this.color;if(this.hasMetallicPaint){var s=t.createLinearGradient(this.x,this.y,this.x,this.y+this.height);s.addColorStop(0,this.color),s.addColorStop(.5,this.lightenColor(this.color,30)),s.addColorStop(1,this.color),i=s}t.fillStyle=i,t.beginPath(),t.moveTo(this.x,this.y+.7*this.height),t.lineTo(this.x,this.y+.25*this.height),t.lineTo(this.x+.2*this.width,this.y+.15*this.height),t.lineTo(this.x+.85*this.width,this.y+.15*this.height),t.lineTo(this.x+this.width,this.y+.25*this.height),t.lineTo(this.x+this.width,this.y+.7*this.height),t.closePath(),t.fill(),t.strokeStyle=this.darkenColor(this.color,20),t.lineWidth=1,t.stroke(),this.drawCarDetails(t,e),t.strokeStyle="#333",t.lineWidth=2,t.beginPath(),t.moveTo(this.x+.25*this.width,this.y+.15*this.height),t.lineTo(this.x+.8*this.width,this.y+.15*this.height),t.stroke();for(var a=0;a<4;a++){var h=this.x+this.width*(.3+.15*a);t.beginPath(),t.moveTo(h,this.y+.15*this.height),t.lineTo(h,this.y+.2*this.height),t.stroke()}t.restore()}},{key:"drawSportsCar",value:function(t,e){t.save();var i=this.color;if(this.hasMetallicPaint){var s=t.createLinearGradient(this.x,this.y,this.x,this.y+this.height);s.addColorStop(0,this.color),s.addColorStop(.5,this.lightenColor(this.color,30)),s.addColorStop(1,this.color),i=s}t.fillStyle=i,t.beginPath(),t.moveTo(this.x,this.y+.6*this.height),t.lineTo(this.x+.1*this.width,this.y+.4*this.height),t.lineTo(this.x+.25*this.width,this.y+.25*this.height),t.lineTo(this.x+.75*this.width,this.y+.25*this.height),t.lineTo(this.x+.95*this.width,this.y+.4*this.height),t.lineTo(this.x+this.width,this.y+.6*this.height),t.closePath(),t.fill(),t.strokeStyle=this.darkenColor(this.color,20),t.lineWidth=1,t.stroke(),this.drawCarDetails(t,e),t.fillStyle="#222",t.fillRect(this.x+.8*this.width,this.y+.25*this.height,.15*this.width,.05*this.height),t.fillStyle="#fff",t.fillRect(this.x+.3*this.width,this.y+.25*this.height,.05*this.width,.35*this.height),t.fillRect(this.x+.6*this.width,this.y+.25*this.height,.05*this.width,.35*this.height),t.fillStyle="#111",t.beginPath(),t.ellipse(this.x+.45*this.width,this.y+.3*this.height,.1*this.width,.05*this.height,0,0,2*Math.PI),t.fill(),t.restore()}},{key:"drawPickupTruck",value:function(t,e){t.save();var i=this.color;if(this.hasMetallicPaint){var s=t.createLinearGradient(this.x,this.y,this.x,this.y+this.height);s.addColorStop(0,this.color),s.addColorStop(.5,this.lightenColor(this.color,30)),s.addColorStop(1,this.color),i=s}t.fillStyle=i,t.beginPath(),t.moveTo(this.x,this.y+.7*this.height),t.lineTo(this.x,this.y+.3*this.height),t.lineTo(this.x+.15*this.width,this.y+.2*this.height),t.lineTo(this.x+.45*this.width,this.y+.2*this.height),t.lineTo(this.x+.45*this.width,this.y+.7*this.height),t.closePath(),t.fill(),t.strokeStyle=this.darkenColor(this.color,20),t.lineWidth=1,t.stroke(),t.fillStyle=i,t.beginPath(),t.moveTo(this.x+.45*this.width,this.y+.7*this.height),t.lineTo(this.x+.45*this.width,this.y+.35*this.height),t.lineTo(this.x+this.width,this.y+.35*this.height),t.lineTo(this.x+this.width,this.y+.7*this.height),t.closePath(),t.fill(),t.strokeStyle=this.darkenColor(this.color,20),t.lineWidth=1,t.stroke(),t.fillStyle=this.darkenColor(this.color,15),t.fillRect(this.x+.45*this.width,this.y+.35*this.height,.55*this.width,.05*this.height),t.fillStyle="#aaddff",t.beginPath(),t.moveTo(this.x+.15*this.width,this.y+.25*this.height),t.lineTo(this.x+.15*this.width,this.y+.2*this.height),t.lineTo(this.x+.45*this.width,this.y+.2*this.height),t.lineTo(this.x+.45*this.width,this.y+.35*this.height),t.lineTo(this.x+.15*this.width,this.y+.35*this.height),t.closePath(),t.fill(),this.drawWheels(t),this.drawLights(t),this.drawLicensePlate(t),t.restore()}},{key:"drawCybertruck",value:function(t,e){t.save();var i=t.createLinearGradient(this.x,this.y,this.x+this.width,this.y+this.height);i.addColorStop(0,"#a0a0a0"),i.addColorStop(.5,"#e0e0e0"),i.addColorStop(1,"#b0b0b0"),t.fillStyle=i,t.beginPath(),t.moveTo(this.x,this.y+.7*this.height),t.lineTo(this.x+.15*this.width,this.y+.4*this.height),t.lineTo(this.x+.3*this.width,this.y+.4*this.height),t.lineTo(this.x+.45*this.width,this.y+.25*this.height),t.lineTo(this.x+.75*this.width,this.y+.25*this.height),t.lineTo(this.x+this.width,this.y+.5*this.height),t.lineTo(this.x+this.width,this.y+.7*this.height),t.closePath(),t.fill(),t.strokeStyle="#888",t.lineWidth=1,t.stroke(),t.fillStyle="rgba(120, 200, 255, 0.7)",t.beginPath(),t.moveTo(this.x+.3*this.width,this.y+.4*this.height),t.lineTo(this.x+.45*this.width,this.y+.25*this.height),t.lineTo(this.x+.75*this.width,this.y+.25*this.height),t.lineTo(this.x+.85*this.width,this.y+.4*this.height),t.closePath(),t.fill(),t.fillStyle="#222",this.wheelGlow&&(t.shadowColor=this.neonColor,t.shadowBlur=10),t.beginPath(),t.arc(this.x+.25*this.width,this.y+.7*this.height,.2*this.height,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.x+.75*this.width,this.y+.7*this.height,.2*this.height,0,2*Math.PI),t.fill(),t.shadowBlur=0,t.fillStyle="#ddd",t.beginPath(),t.arc(this.x+.25*this.width,this.y+.7*this.height,.1*this.height,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.x+.75*this.width,this.y+.7*this.height,.1*this.height,0,2*Math.PI),t.fill(),this.hasNeonLights?(t.fillStyle="#fff",t.shadowColor=this.neonColor,t.shadowBlur=15):(t.fillStyle="#ffff00",t.shadowColor="#ffff00",t.shadowBlur=10),t.fillRect(this.x+.05*this.width,this.y+.35*this.height,.2*this.width,.05*this.height),t.fillRect(this.x+.75*this.width,this.y+.35*this.height,.2*this.width,.05*this.height),t.shadowBlur=0,this.drawLicensePlate(t),t.fillStyle="#000000",t.font="12px Arial",t.textAlign="center",t.fillText(this.licensePlate,this.x+.5*this.width,this.y+.67*this.height),this.hasNeonLights&&(t.fillStyle=this.neonColor,t.shadowColor=this.neonColor,t.shadowBlur=20,t.globalAlpha=.3+.1*Math.sin(.1*e),t.fillRect(this.x+.1*this.width,this.y+.9*this.height,.8*this.width,.05*this.height),t.globalAlpha=1,t.shadowBlur=0),t.restore()}},{key:"drawWheels",value:function(t){t.fillStyle="#222",t.beginPath(),t.arc(this.x+.25*this.width,this.y+.7*this.height,.2*this.height,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.x+.75*this.width,this.y+.7*this.height,.2*this.height,0,2*Math.PI),t.fill(),t.fillStyle="#999",t.beginPath(),t.arc(this.x+.25*this.width,this.y+.7*this.height,.1*this.height,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.x+.75*this.width,this.y+.7*this.height,.1*this.height,0,2*Math.PI),t.fill(),t.strokeStyle="#777",t.lineWidth=2;for(var e=0;e<5;e++){var i=e/5*Math.PI*2;t.beginPath(),t.moveTo(this.x+.25*this.width,this.y+.7*this.height),t.lineTo(this.x+.25*this.width+Math.cos(i)*this.height*.1,this.y+.7*this.height+Math.sin(i)*this.height*.1),t.stroke(),t.beginPath(),t.moveTo(this.x+.75*this.width,this.y+.7*this.height),t.lineTo(this.x+.75*this.width+Math.cos(i)*this.height*.1,this.y+.7*this.height+Math.sin(i)*this.height*.1),t.stroke()}}},{key:"drawLights",value:function(t){t.fillStyle="#ffff00",t.shadowColor="#ffff00",t.shadowBlur=10,t.fillRect(this.x+.05*this.width,this.y+.35*this.height,.1*this.width,.1*this.height),t.fillStyle="#ff0000",t.shadowColor="#ff0000",t.shadowBlur=10,t.fillRect(this.x+.85*this.width,this.y+.35*this.height,.1*this.width,.1*this.height),t.shadowBlur=0}},{key:"drawLicensePlate",value:function(t){t.fillStyle="#ffffff",t.fillRect(this.x+.4*this.width,this.y+.6*this.height,.2*this.width,.1*this.height),t.fillStyle="#000000",t.font="12px Arial",t.textAlign="center",t.fillText(this.licensePlate,this.x+.5*this.width,this.y+.67*this.height)}},{key:"drawCarDetails",value:function(t,e){t.fillStyle="#aaddff",t.beginPath(),t.moveTo(this.x+.25*this.width,this.y+.25*this.height),t.lineTo(this.x+.35*this.width,this.y+.25*this.height),t.lineTo(this.x+.4*this.width,this.y+.35*this.height),t.lineTo(this.x+.2*this.width,this.y+.35*this.height),t.closePath(),t.fill(),t.beginPath(),t.moveTo(this.x+.45*this.width,this.y+.25*this.height),t.lineTo(this.x+.75*this.width,this.y+.25*this.height),t.lineTo(this.x+.8*this.width,this.y+.35*this.height),t.lineTo(this.x+.4*this.width,this.y+.35*this.height),t.closePath(),t.fill(),this.drawWheels(t),this.drawLights(t),this.drawLicensePlate(t),t.strokeStyle=this.darkenColor(this.color,30),t.lineWidth=1,t.beginPath(),t.moveTo(this.x+.4*this.width,this.y+.25*this.height),t.lineTo(this.x+.4*this.width,this.y+.6*this.height),t.stroke(),t.fillStyle="#ddd",t.fillRect(this.x+.35*this.width,this.y+.4*this.height,.05*this.width,.03*this.height),t.fillRect(this.x+.6*this.width,this.y+.4*this.height,.05*this.width,.03*this.height)}},{key:"lightenColor",value:function(t,e){var i=parseInt(t.replace("#",""),16),s=Math.round(2.55*e),a=(i>>16)+s,h=(i>>8&255)+s,o=(255&i)+s;return"#"+(16777216+65536*(a<255?a<1?0:a:255)+256*(h<255?h<1?0:h:255)+(o<255?o<1?0:o:255)).toString(16).slice(1)}},{key:"darkenColor",value:function(t,e){return this.lightenColor(t,-e)}},{key:"explode",value:function(){if(this.isExploding)return!1;this.isExploding=!0,this.explosionTimer=0,this.explosionHitEnemies.clear();var t="cybertruck"===this.type?80:60;this.explosionParticles=[];for(var e=0;e<t;e++){var i,s=Math.random()*Math.PI*2,a=1+5*Math.random(),h=3+8*Math.random(),o=30+40*Math.random(),r=Math.random();i=r<.4?"#ff6600":r<.7?"#ff0000":r<.9?"#ffcc00":"#ffffff",this.explosionParticles.push({x:this.x+this.width/2,y:this.y+this.height/2,size:h,velX:Math.cos(s)*a,velY:Math.sin(s)*a,color:i,life:o,type:"fire"})}for(var n="cybertruck"===this.type?20:15,l=0;l<n;l++){var c,d=Math.random()*Math.PI*2,y=2+6*Math.random(),u=2+4*Math.random(),p=40+60*Math.random();c="cybertruck"===this.type?"#a0a0a0":this.darkenColor(this.color,20),this.explosionParticles.push({x:this.x+Math.random()*this.width,y:this.y+Math.random()*this.height,size:u,velX:Math.cos(d)*y,velY:Math.sin(d)*y-2,color:c,life:p,gravity:.2,type:"debris"})}for(var m="cybertruck"===this.type?15:10,g=0;g<m;g++){var f=Math.random()*Math.PI*2,v=.5+2*Math.random(),w=8+12*Math.random(),b=60+80*Math.random();this.explosionParticles.push({x:this.x+this.width/2,y:this.y+this.height/2,size:w,velX:Math.cos(f)*v,velY:Math.sin(f)*v-1,color:"#555555",life:b,alpha:.7,fadeRate:.01+.02*Math.random(),type:"smoke"})}return!0}},{key:"drawExplosion",value:function(t){var e=this.x+this.width/2,i=this.y+this.height/2,s=t.createRadialGradient(e,i,10,e,i,this.explosionRadius*(1-this.explosionTimer/this.explosionDuration*.8)),a=this.explosionTimer/this.explosionDuration;a<.15?(s.addColorStop(0,"rgba(255, 255, 255, 1.0)"),s.addColorStop(.1,"rgba(255, 255, 200, 0.9)"),s.addColorStop(.3,"rgba(255, 200, 0, 0.8)"),s.addColorStop(.6,"rgba(255, 100, 0, 0.6)"),s.addColorStop(1,"rgba(255, 0, 0, 0)"),t.shadowColor="rgba(255, 200, 0, 0.8)",t.shadowBlur=30):a<.5?(s.addColorStop(0,"rgba(255, 200, 0, 0.9)"),s.addColorStop(.2,"rgba(255, 100, 0, 0.8)"),s.addColorStop(.5,"rgba(200, 0, 0, 0.6)"),s.addColorStop(.8,"rgba(100, 0, 0, 0.3)"),s.addColorStop(1,"rgba(50, 0, 0, 0)"),t.shadowColor="rgba(255, 100, 0, 0.6)",t.shadowBlur=20):(s.addColorStop(0,"rgba(80, 80, 80, 0.8)"),s.addColorStop(.3,"rgba(60, 60, 60, 0.7)"),s.addColorStop(.7,"rgba(40, 40, 40, 0.5)"),s.addColorStop(1,"rgba(20, 20, 20, 0)"),t.shadowColor="rgba(40, 40, 40, 0.4)",t.shadowBlur=10),t.fillStyle=s,t.beginPath(),t.arc(e,i,this.explosionRadius*(1-this.explosionTimer/this.explosionDuration*.7),0,2*Math.PI),t.fill(),t.shadowColor="transparent",t.shadowBlur=0;var h,o=[],r=[],n=[],l=g(this.explosionParticles.slice(0,50));try{for(l.s();!(h=l.n()).done;){var c=h.value;"fire"===c.type?o.push(c):"debris"===c.type?r.push(c):"smoke"===c.type&&n.push(c)}}catch(t){l.e(t)}finally{l.f()}if(o.length>0){var d,y=g(o);try{for(y.s();!(d=y.n()).done;){var u=d.value;t.fillStyle=u.color,t.beginPath(),t.arc(u.x,u.y,u.size*(u.life/40),0,2*Math.PI),t.fill()}}catch(t){y.e(t)}finally{y.f()}}if(r.length>0){var p,m=g(r);try{for(m.s();!(p=m.n()).done;){var f=p.value;t.fillStyle=f.color,t.fillRect(f.x-f.size/2,f.y-f.size/2,f.size,f.size)}}catch(t){m.e(t)}finally{m.f()}}if(n.length>0){var v,w=g(n);try{for(w.s();!(v=w.n()).done;){var b=v.value;t.globalAlpha=b.alpha||.7,t.fillStyle=b.color,t.beginPath(),t.arc(b.x,b.y,b.size*(b.life/100),0,2*Math.PI),t.fill(),t.globalAlpha=1}}catch(t){w.e(t)}finally{w.f()}}a<.15&&(t.strokeStyle="rgba(255, 255, 255, ".concat(.7*(1-7*a),")"),t.lineWidth=2,t.beginPath(),t.arc(e,i,this.explosionRadius*a*5,0,2*Math.PI),t.stroke())}},{key:"drawDamageVisuals",value:function(t){t.fillStyle="#333333";var e,i=g(this.damageVisuals);try{for(i.s();!(e=i.n()).done;){var s=e.value;t.beginPath(),t.arc(this.x+s.x,this.y+s.y,s.size,0,2*Math.PI),t.fill();for(var a=0;a<3;a++){var h=Math.random()*Math.PI*2,o=.8*s.size;t.beginPath(),t.arc(this.x+s.x+Math.cos(h)*o,this.y+s.y+Math.sin(h)*o,.3*s.size,0,2*Math.PI),t.fill()}}}catch(t){i.e(t)}finally{i.f()}}},{key:"isInExplosionRadius",value:function(t){if(!this.isExploding||!t)return!1;var e=this.x+this.width/2,i=this.y+this.height/2,s=e-(t.x+t.width/2),a=i-(t.y+t.height/2);return Math.sqrt(s*s+a*a)<=this.explosionRadius}}])&&v(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function x(t){return x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},x(t)}function S(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,P(s.key),s)}}function P(t){var e=function(t){if("object"!=x(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=x(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==x(e)?e:e+""}var M=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.currentLevel=0,this.levelProgress=0,this.levelPosition=0,this.levelLength=5e3,this.scrollSpeed=1.2,this.spawnedElements=[],this.lastProgressLog=0,console.log("LevelManager initialized with levelPosition:",this.levelPosition)},(e=[{key:"loadLevel",value:function(t){this.currentLevel=t,this.levelProgress=0,this.levelPosition=0,this.spawnedElements=[];var e=this.getLevelData(t);return console.log("Loading level:",e.name,"with",e.elements.length,"elements"),this.game.obstacles=[],this.game.enemies?(console.log("Clearing",this.game.enemies.length,"existing enemies"),this.game.enemies=[]):(console.log("Creating enemies array"),this.game.enemies=[]),this.updateLevelElements(),e}},{key:"getLevelData",value:function(t){return k[Math.min(t,k.length-1)]}},{key:"update",value:function(){this.levelPosition+=this.scrollSpeed*this.game.gameSpeed,this.levelProgress=this.levelPosition/this.levelLength;var t=Date.now();if(t-this.lastProgressLog>5e3&&(console.log("Level progress:",this.levelProgress.toFixed(2),"Position:",this.levelPosition.toFixed(0),"of",this.levelLength),this.lastProgressLog=t),this.updateLevelElements(),this.levelPosition>=this.levelLength){if(console.log("Level complete! Loading next level"),2===this.currentLevel)return void this.game.showMissionComplete();this.currentLevel=(this.currentLevel+1)%k.length;var e=this.loadLevel(this.currentLevel);this.levelPosition=0,this.game.levelDisplay&&(this.game.levelDisplay.textContent=e.name),this.game.showLevelAnnouncement&&this.game.showLevelAnnouncement(e.name)}for(var i=0;i<this.game.obstacles.length;i++){var s=this.game.obstacles[i];s.x-=this.scrollSpeed*this.game.gameSpeed,s.update()}this.preventObstacleOverlap()}},{key:"preventObstacleOverlap",value:function(){var t=this.game.obstacles;if(t&&!(t.length<=1)){t.sort((function(t,e){return t.x-e.x}));for(var e=0;e<t.length-1;e++){var i=t[e],s=t[e+1],a=s.x-(i.x+i.width);a<20&&a>-i.width&&(s.x=i.x+i.width+20)}}}},{key:"updateLevelElements",value:function(){var t=this,e=this.getLevelData(this.currentLevel),i=this.levelProgress*this.levelLength;this.game.frameCount%300==0&&(console.log("Checking for elements at position:",i.toFixed(0)),console.log("Spawn range:",i.toFixed(0),"to",(i+this.game.canvas.width+200).toFixed(0)),console.log("Already spawned elements:",this.spawnedElements.length)),e.elements.filter((function(e){return e.position>i&&e.position<i+t.game.canvas.width+200&&!t.spawnedElements.includes(e.id)})).forEach((function(e){console.log("Spawning element:",e.type,e.subtype,"at position",e.position),t.spawnElement(e),t.spawnedElements.push(e.id)}))}},{key:"spawnElement",value:function(t){var e=t.position-this.levelProgress*this.levelLength,i=this.game.canvas.width+Math.min(e,200);switch(t.type){case"obstacle":var s=new b(i,0,t.subtype,this.game.canvas),a=!1,h=0;s.y=this.game.canvas.height-50-s.height;do{a=!1,h++;for(var o=0;o<this.game.obstacles.length;o++){var r=this.game.obstacles[o];if(!(r.x+r.width<0||r.x>this.game.canvas.width+400)&&s.x<r.x+r.width&&s.x+s.width>r.x&&s.y<r.y+r.height&&s.y+s.height>r.y){a=!0,s.x=r.x+r.width+20;break}}if(h>=10){console.log("Warning: Maximum collision adjustment attempts reached for obstacle");break}}while(a);this.game.obstacles.push(s);break;case"enemy":var n,l=[{color:"#f00",width:30,height:30,speed:1,health:30,maxHealth:30,points:100,tentacles:6},{color:"#a00",width:40,height:40,speed:.6,health:60,maxHealth:60,points:200,tentacles:8},{color:"#faa",width:25,height:25,speed:1.3,health:20,maxHealth:20,points:150,tentacles:5},{color:"#f55",width:50,height:50,speed:.4,health:100,maxHealth:100,points:300,tentacles:10}],d=Math.min(parseInt(t.subtype)||0,l.length-1);n=void 0!==t.y?Math.max(50,Math.min(t.y,this.game.canvas.height-100)):Math.random()*(.67*this.game.canvas.height),console.log("Creating enemy:",d,"at",i,n);try{var y=new c(i,n,l[d],this.game.canvas);this.game.enemies||(console.error("game.enemies is undefined! Creating new array."),this.game.enemies=[]),this.game.enemies.push(y),console.log("Enemy added successfully. Total enemies:",this.game.enemies.length),this.game.soundManager.playAlienWhisper()}catch(t){console.error("Error creating enemy:",t)}}}},{key:"getAllLevels",value:function(){return k}},{key:"resetToFirstLevel",value:function(){return this.loadLevel(0)}},{key:"getCurrentLevel",value:function(){return this.getLevelData(this.currentLevel)}}])&&S(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}(),k=[{name:"Training Grounds",description:"Learn the basics of movement and combat",elements:[{id:1,type:"obstacle",subtype:"box",position:500},{id:2,type:"obstacle",subtype:"box",position:800},{id:3,type:"enemy",subtype:"0",position:1200,y:200},{id:4,type:"obstacle",subtype:"car",position:1500},{id:5,type:"enemy",subtype:"0",position:1800,y:150},{id:6,type:"obstacle",subtype:"box",position:2200},{id:7,type:"obstacle",subtype:"box",position:2300},{id:8,type:"enemy",subtype:"1",position:2600,y:100},{id:9,type:"obstacle",subtype:"cybertruck",position:3e3},{id:10,type:"enemy",subtype:"0",position:3500,y:250},{id:11,type:"obstacle",subtype:"box",position:4e3},{id:12,type:"enemy",subtype:"2",position:4500,y:180}]},{name:"Urban Assault",description:"Navigate through a city under attack",elements:[{id:1,type:"obstacle",subtype:"car",position:300},{id:2,type:"obstacle",subtype:"box",position:500},{id:3,type:"obstacle",subtype:"box",position:600},{id:4,type:"enemy",subtype:"1",position:800,y:150},{id:5,type:"obstacle",subtype:"cybertruck",position:1e3},{id:6,type:"enemy",subtype:"0",position:1200,y:200},{id:7,type:"enemy",subtype:"0",position:1300,y:100},{id:8,type:"obstacle",subtype:"box",position:1500},{id:9,type:"obstacle",subtype:"car",position:1800},{id:10,type:"enemy",subtype:"2",position:2e3,y:180},{id:11,type:"obstacle",subtype:"box",position:2200},{id:12,type:"obstacle",subtype:"box",position:2300},{id:13,type:"enemy",subtype:"1",position:2500,y:120},{id:14,type:"obstacle",subtype:"cybertruck",position:2800},{id:15,type:"enemy",subtype:"3",position:3e3,y:150},{id:16,type:"obstacle",subtype:"box",position:3200},{id:17,type:"obstacle",subtype:"car",position:3500},{id:18,type:"enemy",subtype:"2",position:3800,y:200},{id:19,type:"obstacle",subtype:"box",position:4e3},{id:20,type:"enemy",subtype:"3",position:4500,y:180}]},{name:"Cephalopod Stronghold",description:"Infiltrate the enemy base",elements:[{id:1,type:"enemy",subtype:"1",position:200,y:150},{id:2,type:"obstacle",subtype:"box",position:400},{id:3,type:"enemy",subtype:"0",position:600,y:200},{id:4,type:"obstacle",subtype:"cybertruck",position:800},{id:5,type:"enemy",subtype:"2",position:1e3,y:100},{id:6,type:"enemy",subtype:"1",position:1200,y:200},{id:7,type:"obstacle",subtype:"box",position:1400},{id:8,type:"obstacle",subtype:"box",position:1500},{id:9,type:"enemy",subtype:"3",position:1700,y:150},{id:10,type:"obstacle",subtype:"car",position:2e3},{id:11,type:"enemy",subtype:"2",position:2200,y:180},{id:12,type:"enemy",subtype:"2",position:2300,y:120},{id:13,type:"obstacle",subtype:"box",position:2500},{id:14,type:"enemy",subtype:"3",position:2700,y:150},{id:15,type:"obstacle",subtype:"cybertruck",position:3e3},{id:16,type:"enemy",subtype:"3",position:3200,y:200},{id:17,type:"enemy",subtype:"3",position:3300,y:100},{id:18,type:"obstacle",subtype:"box",position:3500},{id:19,type:"enemy",subtype:"3",position:3800,y:150},{id:20,type:"obstacle",subtype:"car",position:4e3},{id:21,type:"enemy",subtype:"3",position:4200,y:180},{id:22,type:"enemy",subtype:"3",position:4300,y:120},{id:23,type:"enemy",subtype:"3",position:4400,y:200},{id:24,type:"enemy",subtype:"3",position:4500,y:100}]}];const T=M;function C(t){return C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},C(t)}function E(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var s,a,h,o,r=[],n=!0,l=!1;try{if(h=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;n=!1}else for(;!(n=(s=h.call(i)).done)&&(r.push(s.value),r.length!==e);n=!0);}catch(t){l=!0,a=t}finally{try{if(!n&&null!=i.return&&(o=i.return(),Object(o)!==o))return}finally{if(l)throw a}}return r}}(t,e)||function(t,e){if(t){if("string"==typeof t)return I(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?I(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function I(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,s=Array(e);i<e;i++)s[i]=t[i];return s}function A(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,O(s.key),s)}}function O(t){var e=function(t){if("object"!=C(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=C(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==C(e)?e:e+""}const L=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.sounds={},this.backgroundMusic=null,this.policeRadioSound1=null,this.policeRadioSound2=null,this.currentPoliceRadioIndex=0,this.policeRadioInterval=this.getRandomInterval(3e4,45e3),this.soundEnabled="false"!==localStorage.getItem("soundEnabled"),this.soundToggleElement=document.getElementById("sound-toggle"),this.soundToggleElement&&(this.soundToggleElement.textContent=this.soundEnabled?"🔊":"🔇",this.soundEnabled||this.soundToggleElement.classList.add("muted"))},e=[{key:"loadSounds",value:function(t){for(var e=0,i=Object.entries(t);e<i.length;e++){var s=E(i[e],2),a=s[0],h=s[1],o=new Audio(h);this.sounds[a]=o}this.sounds.backgroundMusic&&(this.backgroundMusic=this.sounds.backgroundMusic,this.backgroundMusic.loop=!0,this.backgroundMusic.volume=.3),this.sounds.policeRadio1&&this.sounds.policeRadio2&&(this.policeRadioSound1=this.sounds.policeRadio1,this.policeRadioSound2=this.sounds.policeRadio2,this.policeRadioSound1.volume=.4,this.policeRadioSound2.volume=.4)}},{key:"toggleSound",value:function(){this.soundEnabled=!this.soundEnabled,localStorage.setItem("soundEnabled",this.soundEnabled),this.soundToggleElement&&(this.soundEnabled?(this.soundToggleElement.textContent="🔊",this.soundToggleElement.classList.remove("muted"),this.game.gameStarted&&!this.game.gameOver&&this.backgroundMusic.play().catch((function(t){return console.warn("Could not play background music:",t)}))):(this.soundToggleElement.textContent="🔇",this.soundToggleElement.classList.add("muted"),this.backgroundMusic.pause())),console.log("Sound ".concat(this.soundEnabled?"enabled":"disabled"))}},{key:"playSound",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;if(this.soundEnabled&&this.sounds[t])try{var i=this.sounds[t].cloneNode();i.volume=e,i.play()}catch(e){console.warn("Could not play ".concat(t," sound:"),e)}}},{key:"playBackgroundMusic",value:function(){if(this.soundEnabled&&this.backgroundMusic)try{this.backgroundMusic.currentTime=0,this.backgroundMusic.play().catch((function(t){return console.warn("Could not play background music:",t)}))}catch(t){console.warn("Could not play background music:",t)}}},{key:"stopBackgroundMusic",value:function(){this.backgroundMusic&&(this.backgroundMusic.pause(),this.backgroundMusic.currentTime=0)}},{key:"playPoliceRadio",value:function(){if(this.soundEnabled)try{0===this.currentPoliceRadioIndex?(this.policeRadioSound1.currentTime=0,this.policeRadioSound1.play(),this.currentPoliceRadioIndex=1):(this.policeRadioSound2.currentTime=0,this.policeRadioSound2.play(),this.currentPoliceRadioIndex=0),this.policeRadioInterval=this.getRandomInterval(3e4,45e3)}catch(t){console.warn("Could not play police radio sound:",t)}}},{key:"playAlienWhisper",value:function(){if(this.soundEnabled)try{var t=Math.floor(3*Math.random())+1,e=this.sounds["alienWhisper".concat(t)];e.volume=.7,e.currentTime=0,e.play()}catch(t){console.warn("Could not play alien whisper sound:",t)}}},{key:"getRandomInterval",value:function(t,e){return Math.floor(Math.random()*(e-t+1))+t}}],e&&A(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function B(t){return B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},B(t)}function R(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,D(s.key),s)}}function D(t){var e=function(t){if("object"!=B(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=B(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==B(e)?e:e+""}const j=function(){return t=function t(e){var i=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.keys={},this.isProcessingKey=!1,this.soundToggleElement=document.getElementById("sound-toggle"),this.helpToggleElement=document.getElementById("help-toggle"),this.startInstruction=document.getElementById("start-instruction"),this.restartInstruction=document.getElementById("restart-instruction"),this.missionCompleteInstruction=document.getElementById("mission-complete-instruction"),this.helpToggleElement&&(this.helpToggleElement.onclick=function(t){return console.log("Help toggle clicked"),t.preventDefault(),t.stopPropagation(),i.game.togglePause(),!1})},e=[{key:"bindEventListeners",value:function(){window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this)),this.handleClickEvents()}},{key:"handleKeyDown",value:function(t){var e=this;if(!t.metaKey&&!t.ctrlKey||t.ctrlKey&&("KeyS"===t.code||"KeyE"===t.code||"Digit1"===t.code))if(this.keys[t.key]=!0,"block"!==this.game.missionCompleteScreen.style.display&&"block"!==this.game.gameOverScreen.style.display){if("Enter"===t.key&&this.game.gameStarted&&!this.game.gameOver){var i=this.game.player.switchWeapon();this.game.weaponDisplay.textContent=i}"Space"===t.code&&(this.game.gameStarted||this.game.gameOver?this.game.isPaused?this.game.togglePause():this.game.gameOver&&(this.game.resetGame(),this.game.startGame()):this.game.startGame()),this.game.gameStarted&&!this.game.gameOver&&("["===t.key?this.game.goToPreviousLevel():"]"===t.key&&this.game.goToNextLevel()),"KeyS"===t.code&&t.ctrlKey&&(t.preventDefault(),this.game.soundManager.toggleSound()),"KeyE"===t.code&&t.ctrlKey&&this.game.gameStarted&&!this.game.gameOver&&(t.preventDefault(),this.game.triggerElonToasty(),console.log("Elon Toasty triggered by keyboard shortcut")),"Digit1"===t.code&&t.ctrlKey&&this.game.gameStarted&&!this.game.gameOver&&(t.preventDefault(),this.game.showMissionComplete(),console.log("Mission complete screen triggered by keyboard shortcut"))}else{if(/^[a-zA-Z0-9 ]$/.test(t.key)||"Backspace"===t.key||"Enter"===t.key){if(t.preventDefault(),this.isProcessingKey)return;this.isProcessingKey=!0,this.game.handleNameInput(t.key),setTimeout((function(){e.isProcessingKey=!1}),50)}if("Enter"===t.key)return void("block"===this.game.missionCompleteScreen.style.display?this.game.playerName.some((function(t){return"_"!==t}))&&this.game.saveScore():"block"===this.game.gameOverScreen.style.display&&this.game.gameOverPlayerName.some((function(t){return"_"!==t}))&&this.game.saveGameOverScore());"Space"===t.code&&(this.game.resetGame(),this.game.startGame())}}},{key:"handleKeyUp",value:function(t){t.metaKey||t.ctrlKey&&"KeyS"!==t.code&&"KeyE"!==t.code&&"Digit1"!==t.code||(this.keys[t.key]=!1)}},{key:"handleClickEvents",value:function(){var t=this;this.soundToggleElement&&this.soundToggleElement.addEventListener("click",(function(){t.game.soundManager.toggleSound()})),this.startInstruction&&this.startInstruction.addEventListener("click",(function(){t.game.gameStarted||t.game.gameOver?t.game.isPaused&&t.game.togglePause():t.game.startGame()})),this.restartInstruction&&this.restartInstruction.addEventListener("click",(function(){t.game.gameOver&&(t.game.resetGame(),t.game.startGame())})),this.missionCompleteInstruction&&this.missionCompleteInstruction.addEventListener("click",(function(){"block"===t.missionCompleteInstruction.style.display&&(t.game.resetGame(),t.game.startGame())}))}},{key:"isKeyPressed",value:function(t){return!0===this.keys[t]}},{key:"resetKeys",value:function(){this.keys={}}}],e&&R(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function _(t){return _="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_(t)}function N(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,G(s.key),s)}}function G(t){var e=function(t){if("object"!=_(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=_(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==_(e)?e:e+""}const F=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.elonToasty={active:!1,x:0,y:0,width:150,height:150,image:new Image,timer:0,duration:120,slideInDuration:15,slideOutDuration:15,slideInComplete:!1},this.elonToasty.image.src="images/elon.png",this.damageFlash={active:!1,duration:10,timer:0,color:"rgba(255, 0, 0, 0.3)"}},(e=[{key:"triggerElonToasty",value:function(){this.elonToasty.active||(this.elonToasty.active=!0,this.elonToasty.x=this.game.canvas.width,this.elonToasty.slideInComplete=!1,this.elonToasty.timer=0,this.game.soundManager.playSound("toasty",.7))}},{key:"drawElonToasty",value:function(t){if(this.elonToasty.active){var e=this.game.canvas;if(this.elonToasty.timer++,!this.elonToasty.slideInComplete&&this.elonToasty.timer<=this.elonToasty.slideInDuration){var i=this.elonToasty.timer/this.elonToasty.slideInDuration;this.elonToasty.x=e.width-this.elonToasty.width*i}else if(this.elonToasty.slideInComplete){if(this.elonToasty.timer>=this.elonToasty.duration-this.elonToasty.slideOutDuration){var s=(this.elonToasty.timer-(this.elonToasty.duration-this.elonToasty.slideOutDuration))/this.elonToasty.slideOutDuration;this.elonToasty.x=e.width-this.elonToasty.width+this.elonToasty.width*s}}else this.elonToasty.slideInComplete=!0,this.elonToasty.timer=0;t.drawImage(this.elonToasty.image,this.elonToasty.x,e.height-this.elonToasty.height,this.elonToasty.width,this.elonToasty.height),this.elonToasty.timer>=this.elonToasty.duration&&(this.elonToasty.active=!1)}}},{key:"triggerDamageFlash",value:function(){this.damageFlash.active=!0,this.damageFlash.timer=0}},{key:"updateDamageFlash",value:function(){this.damageFlash.active&&(this.damageFlash.timer++,this.damageFlash.timer>=this.damageFlash.duration&&(this.damageFlash.active=!1))}},{key:"drawDamageFlash",value:function(t){if(this.damageFlash.active){var e=1-this.damageFlash.timer/this.damageFlash.duration,i="rgba(255, 0, 0, ".concat(.3*e,")");t.fillStyle=i,t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height)}}},{key:"update",value:function(){this.updateDamageFlash()}},{key:"draw",value:function(t){this.drawDamageFlash(t),this.drawElonToasty(t)}}])&&N(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function W(t){return W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},W(t)}function H(t){return function(t){if(Array.isArray(t))return U(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||Y(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Y(t,e){if(t){if("string"==typeof t)return U(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?U(t,e):void 0}}function U(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,s=Array(e);i<e;i++)s[i]=t[i];return s}function z(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,s)}return i}function q(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?z(Object(i),!0).forEach((function(e){K(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):z(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function K(t,e,i){return(e=V(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function X(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,V(s.key),s)}}function V(t){var e=function(t){if("object"!=W(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=W(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==W(e)?e:e+""}const $=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.canvas=e,this.ctx=e.getContext("2d"),this.gameStarted=!1,this.gameOver=!1,this.isPaused=!1,this.score=0,this.frameCount=0,this.lastSpawnTime=0,this.gameSpeed=1,this.lastPoliceRadioTime=0,this.scores=[],this.scoresLoaded=!1,this.scoresError=null,this.soundManager=new L(this),this.inputManager=new j(this),this.effectsManager=new F(this),this.lastFrameTime=0,this.animationFrameId=null,this.mushroomPowerDuration=600,this.mushroomPowerTimer=0,this.healthBar=document.getElementById("health-bar"),this.healthValue=document.getElementById("health-value"),this.scoreDisplay=document.getElementById("score"),this.weaponDisplay=document.getElementById("weapon"),this.specialTokensDisplay=document.getElementById("special-tokens"),this.finalScoreDisplay=document.getElementById("final-score"),this.gameOverScreen=document.getElementById("game-over"),this.startScreen=document.getElementById("start-screen"),this.levelDisplay=document.getElementById("level"),this.levelAnnouncement=document.getElementById("level-announcement"),this.missionCompleteScreen=document.getElementById("mission-complete"),this.missionCompleteScore=document.getElementById("mission-complete-score"),this.enterKeyButton=document.getElementById("enter-key"),this.soundToggle=document.getElementById("sound-toggle"),this.helpToggle=document.getElementById("help-toggle"),this.scoreboardOverlay=document.getElementById("scoreboard-overlay"),this.viewScoreboard=document.getElementById("view-scoreboard"),this.closeScoreboard=document.getElementById("close-scoreboard"),this.nameInputSection=document.getElementById("name-input-section"),this.nameChars=Array.from(document.querySelectorAll(".name-char")),this.currentNameIndex=0,this.playerName=["_","_","_","_","_","_"],this.gameOverNameInputSection=document.getElementById("game-over-name-input-section"),this.gameOverNameChars=Array.from(document.querySelectorAll(".game-over-name-char")),this.gameOverCurrentNameIndex=0,this.gameOverPlayerName=["_","_","_","_","_","_"],this.weapons=[{name:"GLOWING CANNON",color:"#ffffff",damage:15,fireRate:15,projectileSpeed:10,width:10,height:10,isGlowing:!0},{name:"NEURAL BEAM",color:"#ff8c00",damage:10,fireRate:10,projectileSpeed:12,width:5,height:2},{name:"TENTACLE SCRAMBLER",color:"#f0f",damage:20,fireRate:20,projectileSpeed:8,width:8,height:8},{name:"ROBOHORSE CANNON",color:"#0f0",damage:30,fireRate:30,projectileSpeed:10,width:10,height:4},{name:"LEG LAUNCHERS",color:"#ff0",damage:5,fireRate:5,projectileSpeed:15,width:3,height:3}],this.player=new o(e,this.weapons),this.background=new p(e),this.enemies=[],this.projectiles=[],this.powerUps=[],this.specialTokens=[],this.obstacles=[],this.particles=[],this.platforms=[],this.generateTerrain(),console.log("Initializing level manager with enemies array:",this.enemies),this.levelManager=new T(this),this.soundManager.loadSounds({explosion:"audio/explosion.mp3",carHit:"audio/car_hit.mp3",toasty:"audio/toasty.mp3",blasterGlowing:"audio/blaster_shot_high.mp3",blasterNeural:"audio/blaster_shot_snap.mp3",blasterTentacle:"audio/blaster_shots_pee.mp3",blasterRobo:"audio/blaster_shots.mp3",blasterLeg:"audio/blaster_shot_leg.mp3",powerUp:"audio/power_up.mp3",victory:"audio/power_up.mp3",horseScream:"audio/horse_scream_die.mp3",alienWhisper1:"audio/alien_whisper_1.mp3",alienWhisper2:"audio/alien_whisper_2.mp3",alienWhisper3:"audio/alien_whisper_3.mp3",backgroundMusic:"audio/soundtrack_1.mp3",policeRadio1:"audio/police_radio_1.mp3",policeRadio2:"audio/police_radio_2.mp3"}),this.weaponSounds={"GLOWING CANNON":"blasterGlowing","NEURAL BEAM":"blasterNeural","TENTACLE SCRAMBLER":"blasterTentacle","ROBOHORSE CANNON":"blasterRobo","LEG LAUNCHERS":"blasterLeg"},this.bindEventListeners(),this.lastKeyTime=0,this.keyDebounceTime=100,this.startScreenToggleTimer=0,this.showingScoreboard=!1,this.startInstructionElement=null,this.animate=this.animate.bind(this),this.fetchScores()},e=[{key:"fetchScores",value:function(){var t=this;console.log("Pre-fetching scores on app load"),fetch("/api/scores").then((function(t){if(!t.ok)throw new Error("Failed to fetch scores");return t.json()})).then((function(e){t.scores=e,t.scoresLoaded=!0,t.scoresError=null,console.log("Scores pre-fetched successfully:",e.length)})).catch((function(e){console.error("Error pre-fetching scores:",e),t.scoresError=e.message}))}},{key:"toggleSound",value:function(){this.soundManager.toggleSound()}},{key:"togglePause",value:function(){if(console.log("togglePause called, gameStarted:",this.gameStarted,"gameOver:",this.gameOver),!this.gameStarted&&!this.gameOver)return console.log("Game not started - showing help/instructions"),this.startScreen.style.display="block",void(this.helpToggle&&this.helpToggle.classList.add("active"));this.gameStarted&&!this.gameOver&&(this.isPaused=!this.isPaused,console.log("Game paused:",this.isPaused),this.isPaused?(this.startScreen.style.display="block",this.helpToggle?this.helpToggle.classList.add("active"):console.warn("Help toggle element not found"),document.getElementById("start-instruction")&&(document.getElementById("start-instruction").textContent="Press SPACE to resume")):(this.startScreen.style.display="none",this.helpToggle&&this.helpToggle.classList.remove("active"),this.animationFrameId||this.animate(performance.now())))}},{key:"playSound",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;this.soundManager.playSound(t,e)}},{key:"bindEventListeners",value:function(){var t=this;this.inputManager.bindEventListeners(),this.enterKeyButton&&this.enterKeyButton.addEventListener("click",(function(){"block"===t.missionCompleteScreen.style.display&&t.playerName.some((function(t){return"_"!==t}))&&t.saveScore()}));var e=document.getElementById("game-over-enter-key");e&&e.addEventListener("click",(function(){"block"===t.gameOverScreen.style.display&&t.gameOverPlayerName.some((function(t){return"_"!==t}))&&t.saveGameOverScore()})),this.viewScoreboard.addEventListener("click",(function(){t.showScoreboard()})),this.closeScoreboard.addEventListener("click",(function(){t.hideScoreboard()}))}},{key:"startGame",value:function(){this.gameStarted=!0,this.gameOver=!1,this.startScreen.style.display="none",this.hideScoreboard(),this.showingScoreboard=!1,this.soundManager.playBackgroundMusic();var t=this.levelManager.getLevelData(this.levelManager.currentLevel);this.showLevelAnnouncement(t.name),this.lastPoliceRadioTime=performance.now(),this.animate()}},{key:"resetGame",value:function(){this.gameStarted=!1,this.gameOver=!1,this.score=0,this.frameCount=0,this.lastSpawnTime=0,this.gameSpeed=1,this.mushroomPowerTimer=0,this.startScreenToggleTimer=0,this.showingScoreboard=!1,this.startScreen.style.display="block",this.hideScoreboard(),this.startInstructionElement||(this.startInstructionElement=document.getElementById("start-instruction")),this.player.reset(),this.enemies=[],this.projectiles=[],this.powerUps=[],this.specialTokens=[],this.obstacles=[],this.particles=[],this.platforms=[],this.levelManager.resetToFirstLevel();var t=this.levelManager.getCurrentLevel();this.levelDisplay&&t&&(this.levelDisplay.textContent=t.name),this.updateHealthDisplay(),this.scoreDisplay.textContent="0",this.weaponDisplay&&(this.weaponDisplay.textContent=this.player.currentWeapon.name),this.specialTokensDisplay&&(this.specialTokensDisplay.textContent=this.player.specialTokens),this.gameOverScreen.style.display="none",this.missionCompleteScreen.style.display="none",this.startScreen.style.display="block",this.nameChars.forEach((function(t){return t.classList.remove("active")})),this.currentNameIndex=0,this.playerName=["_","_","_","_","_","_"],this.gameOverNameChars.forEach((function(t){return t.classList.remove("active")})),this.gameOverCurrentNameIndex=0,this.gameOverPlayerName=["_","_","_","_","_","_"],this.bindEventListeners(),this.generateTerrain(),this.animate(0)}},{key:"endGame",value:function(){var t=this;if(this.gameOver=!0,this.gameStarted=!1,this.finalScoreDisplay.textContent=this.score,this.gameOverScreen.style.display="block",0===this.score){this.gameOverNameInputSection&&(this.gameOverNameInputSection.style.display="none");var e=document.getElementById("game-over-enter-key");e&&(e.style.display="none");var i=document.getElementById("restart-instruction");i&&(i.style.display="block",i.innerHTML='Press <span class="control-key">SPACE</span> to restart');var s=document.getElementById("view-scoreboard");s&&(s.style.display="block")}else{this.gameOverNameInputSection&&(this.gameOverNameInputSection.style.display="block"),this.gameOverNameChars=Array.from(document.querySelectorAll(".game-over-name-char")),0===this.gameOverNameChars.length?setTimeout((function(){t.gameOverNameChars=Array.from(document.querySelectorAll(".game-over-name-char")),t.gameOverCurrentNameIndex=0,t.gameOverPlayerName=["_","_","_","_","_","_"],t.updateNameDisplay(!1)}),100):(this.gameOverCurrentNameIndex=0,this.gameOverPlayerName=["_","_","_","_","_","_"],this.updateNameDisplay(!1));var a=document.querySelector(".name-input-container");a&&(a.style.display="flex");var h=document.getElementById("game-over-enter-key");h&&(h.style.display="flex");var o=document.getElementById("restart-instruction");o&&(o.style.display="none",o.innerHTML='Press <span class="control-key">SPACE</span> to restart');var r=document.getElementById("view-scoreboard");if(r&&(r.style.display="none"),this.gameOverNameInputSection&&this.gameOverNameInputSection.__x)try{this.gameOverNameInputSection.__x.$data.name=["_","_","_","_","_","_"],this.gameOverNameInputSection.__x.$data.currentIndex=0}catch(t){console.error("Error updating Alpine.js state:",t)}}this.soundManager.stopBackgroundMusic(),this.soundManager.playSound("horseScream",.7)}},{key:"update",value:function(t){var e=this;if(this.gameStarted&&!this.gameOver){t=t||1,this.frameCount++,this.player.update(this.inputManager.keys,this.frameCount,this.createParticles.bind(this),(function(t){var i=e.weaponSounds[t];i&&e.soundManager.playSound(i,.3)}),t);for(var s=this.obstacles.length-1;s>=0;s--){var a=this.obstacles[s];if(a.x+a.width<-300)this.obstacles.splice(s,1);else if(a.update&&a.update(t),("car"===a.type||"cybertruck"===a.type)&&a.isExploding&&a.explosionRadius<=0)this.obstacles.splice(s,1);else if("car_explosion"!==a.type&&"cybertruck_explosion"!==a.type||a.isExploding&&!(a.explosionRadius<=0)){if(i(this.player,a)){if("car_explosion"===a.type||"cybertruck_explosion"===a.type)continue;this.handlePlayerObstacleCollision(a)}if(!a.isExploding&&("car"===a.type||"cybertruck"===a.type||"box"===a.type))for(var h=this.projectiles.length-1;h>=0;h--){var o=this.projectiles[h];if(o.isPlayerProjectile&&!(Math.abs(o.x-a.x)>100||Math.abs(o.y-a.y)>100)&&i(o,a)&&(this.projectiles.splice(h,1),this.createParticles(o.x,o.y,3,o.color),"car"!==a.type&&"cybertruck"!==a.type||this.soundManager.playSound("carHit",.3),a.takeDamage(o.damage)||"box"===a.type&&a.health<=0)){"box"===a.type?(this.soundManager.playSound("carHit",.5),a.containsMushroom&&this.spawnMushroomPowerUp(a.x,a.y-20),this.createParticles(a.x+a.width/2,a.y+a.height/2,15,a.color),this.obstacles.splice(s,1)):(this.soundManager.playSound("explosion",.5),a.explode(),this.obstacles.splice(s,1),this.obstacles.push(q(q({},a),{},{type:a.type+"_explosion",x:a.x,y:a.y,width:a.width,height:a.height,isExploding:!0,explosionTimer:0,explosionDuration:a.explosionDuration,explosionRadius:a.explosionRadius,explosionParticles:a.explosionParticles,explosionHitEnemies:a.explosionHitEnemies,update:a.update,draw:function(t,e){this.drawExplosion(t)},drawExplosion:a.drawExplosion,isInExplosionRadius:a.isInExplosionRadius})),"cybertruck"===a.type&&Math.random()<.1&&this.triggerElonToasty()),this.score+=a.points,this.scoreDisplay.textContent=this.score;break}}}else this.obstacles.splice(s,1)}for(var r=!1,n=this.player.y+this.player.height,l=this.player.x+this.player.width,c=this.player.x+this.player.width/2,d=this.canvas.width/2,y=0;y<this.platforms.length;y++){var u=this.platforms[y];Math.abs(u.x-this.player.x)>d||"pillar"!==u.type&&(this.player.velY>=0&&n<=u.y+10&&n>=u.y-10&&this.player.x<u.x+u.width&&l>u.x&&(this.player.y=u.y-this.player.height,this.player.velY=0,this.player.isJumping=!1,r=!0,this.player.lastVelY>3&&this.createParticles(this.player.x+this.player.width/2,this.player.y+this.player.height,5,"#aaa")),"shelf"===u.type&&n>u.y+5&&this.player.y<u.y+u.height&&(l>=u.x&&l<=u.x+20&&this.player.x<u.x?this.player.x=u.x-this.player.width:this.player.x<=u.x+u.width&&this.player.x>=u.x+u.width-20&&l>u.x+u.width&&(this.player.x=u.x+u.width)))}if(!r){for(var p=null,m=0;m<this.platforms.length;m++){var g=this.platforms[m];if("ground"===g.type&&!(Math.abs(g.x-this.player.x)>d)&&c>=g.x&&c<g.x+g.width){p=g;break}}p&&this.player.y+this.player.height>p.y&&(this.player.y=p.y-this.player.height,this.player.velY=0,this.player.isJumping=!1,this.player.lastVelY>3&&this.createParticles(this.player.x+this.player.width/2,this.player.y+this.player.height,5,"#aaa"))}this.inputManager.keys[" "]&&this.player.shoot(this.frameCount,this.projectiles,this.createParticles.bind(this),(function(t){var i=e.weaponSounds[t];i&&e.soundManager.playSound(i,.3)})),this.inputManager.keys.c?this.player.specialAbility(this.frameCount,this.projectiles,this.createParticles.bind(this),(function(t){var i=e.weaponSounds[t];i&&e.soundManager.playSound(i,.3)}))&&(this.specialTokensDisplay.textContent=this.player.specialAbilityTokens):this.player.specialAbilityActive&&this.player.specialAbility(this.frameCount,this.projectiles,this.createParticles.bind(this),(function(t){var i=e.weaponSounds[t];i&&e.soundManager.playSound(i,.3)}))&&(this.specialTokensDisplay.textContent=this.player.specialAbilityTokens),this.levelManager.update();for(var f=this.projectiles.length-1;f>=0;f--){var v=this.projectiles[f];v.x+=v.velX*t,v.isSineWave?(v.sinePhase+=v.sineFrequency*t,v.y=v.initialY+Math.sin(v.sinePhase)*v.sineAmplitude,this.frameCount%2==0&&this.createParticles(v.x+v.width/2,v.y+v.height/2,1,v.color)):v.y+=v.velY*t;var w=this.canvas.height-50;if(v.y+v.height>w+5){if(Math.random()<.7||!v.isPlayerProjectile){this.projectiles.splice(f,1),this.createParticles(v.x+v.width/2,w,5,v.color);continue}v.velY=.4*-v.velY,v.y=w+5-v.height}(v.x<-50||v.x>this.canvas.width+50||v.y<-50||v.y>this.canvas.height+50)&&this.projectiles.splice(f,1)}for(var b=this.enemies.length-1;b>=0;b--){var x=this.enemies[b];if(x.update(this.player,this.frameCount,this.createParticles.bind(this),t),x.x+x.width<-100||x.x>this.canvas.width+300)this.removeEnemyFromExplosionSets(x),this.enemies.splice(b,1);else{for(var S=0;S<this.obstacles.length;S++){var P=this.obstacles[S];if(("car"===P.type||"cybertruck"===P.type||"car_explosion"===P.type||"cybertruck_explosion"===P.type)&&P.isExploding){if(!x||P.explosionHitEnemies.has(x))continue;if(P.isInExplosionRadius(x)){var M=x.takeDamage(P.explosionDamage);if(P.explosionHitEnemies.add(x),this.createParticles(x.x+x.width/2,x.y+x.height/2,10,"#ff6600"),M){this.removeEnemyFromExplosionSets(x),this.enemies.splice(b,1),this.score+=x.points,this.scoreDisplay.textContent=this.score,this.createParticles(x.x+x.width/2,x.y+x.height/2,20,"#f00");var k=Math.random();k<.2?this.spawnPowerUp(x.x,x.y):k<.5&&this.spawnSpecialToken(x.x,x.y);break}}}}if(!(b>=this.enemies.length)){for(var T=this.projectiles.length-1;T>=0;T--){var C=this.projectiles[T];if(!(!C.isPlayerProjectile||Math.abs(C.x-x.x)>100||Math.abs(C.y-x.y)>100)&&i(C,x)){var E=x.takeDamage(C.damage);if(this.projectiles.splice(T,1),this.createParticles(C.x,C.y,5,C.color),E){this.removeEnemyFromExplosionSets(x),this.enemies.splice(b,1),this.score+=x.points,this.scoreDisplay.textContent=this.score,this.createParticles(x.x+x.width/2,x.y+x.height/2,20,"#f00");var I=Math.random();I<.2?this.spawnPowerUp(x.x,x.y):I<.5&&this.spawnSpecialToken(x.x,x.y);break}}}b<this.enemies.length&&i(this.enemies[b],this.player)&&(this.player.health=Math.max(0,this.player.health-1),this.updateHealthDisplay(),this.createParticles(this.player.x+this.player.width/2,this.player.y+this.player.height/2,3,"#fff"),this.effectsManager.triggerDamageFlash(),this.player.mushroomPowerActive&&this.player.deactivateMushroomPower(this.createParticles.bind(this)),this.player.health<=0&&this.endGame())}}}for(var A=this.projectiles.length-1;A>=0;A--){var O=this.projectiles[A];O.isPlayerProjectile||Math.abs(O.x-this.player.x)>100||Math.abs(O.y-this.player.y)>100||i(O,this.player)&&(this.player.health=Math.max(0,this.player.health-O.damage),this.updateHealthDisplay(),this.projectiles.splice(A,1),this.createParticles(O.x,O.y,10,O.color),this.effectsManager.triggerDamageFlash(),this.player.mushroomPowerActive&&this.player.deactivateMushroomPower(this.createParticles.bind(this)),this.player.health<=0&&this.endGame())}this.frameCount-this.lastSpawnTime>300&&(this.spawnEnemy(),this.lastSpawnTime=this.frameCount),this.powerUps.forEach((function(t,s){t.y+=.5*Math.sin(.1*e.frameCount);var a=e.canvas.height-50;t.y+t.height>a+10&&(t.y=a+10-t.height),i(t,e.player)&&(e.soundManager.playSound("powerUp",.5),"health"===t.type?(e.player.health=Math.min(e.player.health+20,e.player.maxHealth),e.updateHealthDisplay()):"weapon"===t.type?(e.player.currentWeaponIndex=(e.player.currentWeaponIndex+1)%e.weapons.length,e.weaponDisplay.textContent=e.weapons[e.player.currentWeaponIndex].name):"mushroom"===t.type&&e.player.activateMushroomPower(e.createParticles.bind(e),(function(){e.soundManager.playSound("powerUp",.6)})),e.powerUps.splice(s,1),e.createParticles(t.x+t.width/2,t.y+t.height/2,15,t.color))})),this.specialTokens.forEach((function(t,s){t.y+=.5*Math.sin(.1*e.frameCount);var a=e.canvas.height-50;t.y+t.height>a+10&&(t.y=a+10-t.height),i(t,e.player)&&e.player.specialAbilityTokens<e.player.maxSpecialAbilityTokens&&(e.soundManager.playSound("powerUp",.5),e.player.specialAbilityTokens++,e.specialTokensDisplay.textContent=e.player.specialAbilityTokens,e.specialTokens.splice(s,1),e.createParticles(t.x+t.width/2,t.y+t.height/2,15,t.color))})),this.particles.length>100&&this.particles.splice(0,this.particles.length-100),this.particles.forEach((function(t,i){t.x+=t.velX,t.y+=t.velY,t.size-=.1;var s=e.canvas.height-50;t.y>s&&(Math.random()<.5?t.velY=.5*-t.velY:t.size-=.3),t.size<=0&&e.particles.splice(i,1)})),!this.player.mushroomPowerActive||this.player.isGrowing||this.player.isShrinking||(this.mushroomPowerTimer++,this.mushroomPowerTimer>=this.mushroomPowerDuration&&(this.mushroomPowerTimer=0,this.player.deactivateMushroomPower(this.createParticles.bind(this)))),this.effectsManager.update(),this.frameCount%1e3==0&&(this.gameSpeed+=.05),this.frameCount%600==0&&(console.log("Current enemies:",this.enemies.length),this.enemies.length>0&&this.enemies.length<10&&console.log("Enemy positions:",this.enemies.map((function(t){return"(".concat(Math.round(t.x),",").concat(Math.round(t.y),")")})).join(", ")));for(var L=0;L<this.platforms.length;L++){var B=this.platforms[L];if(B.x-=this.levelManager.scrollSpeed*this.gameSpeed,"ground"===B.type&&B.x+B.width<-100){for(var R={x:0},D=0;D<this.platforms.length;D++){var j=this.platforms[D];"ground"===j.type&&j.x>R.x&&(R=j)}B.x=R.x+R.width-1;var _=Math.floor(B.x/100),N=20*Math.sin(.5*_);B.y=this.canvas.height-50+N,B.height=50-N}if(("shelf"===B.type||"pillar"===B.type)&&B.x+B.width<-200){for(var G=[],F=0;F<this.platforms.length;F++)"shelf"===this.platforms[F].type&&G.push(this.platforms[F]);for(var W={x:0},H=0;H<G.length;H++)G[H].x>W.x&&(W=G[H]);if("shelf"===B.type){B.x=W.x+400;var Y=this.canvas.height-50,U=G.indexOf(B);B.y=Y-100-U%3*50;for(var z=0;z<this.platforms.length;z++){var K=this.platforms[z];if("pillar"===K.type&&Math.abs(K.x-(B.x+65))<20){K.x=B.x+65,K.y=B.y+20,K.height=Y-B.y-20;break}}}}}if(this.gameStarted&&!this.gameOver){var X=this.lastPoliceRadioTime?performance.now()-this.lastPoliceRadioTime:0;this.lastPoliceRadioTime&&X>=(this.lastPoliceRadioTime===performance.now()?2e4:this.soundManager.policeRadioInterval)&&(this.soundManager.playPoliceRadio(),this.lastPoliceRadioTime=performance.now())}}}},{key:"handlePlayerObstacleCollision",value:function(t){if(this.player.y+this.player.height<t.y+t.height/2&&this.player.velY>0){if(this.player.velY,this.player.y=t.y-this.player.height,this.player.velY=0,this.player.isJumping=!1,this.player.standingOnObstacle=t,"box"===t.type&&this.player.checkBoxSmash([t],this.createParticles.bind(this))){var e=this.obstacles.indexOf(t);-1!==e&&(t.containsMushroom&&this.spawnMushroomPowerUp(t.x,t.y-20),this.obstacles.splice(e,1),this.score+=t.points,this.scoreDisplay.textContent=this.score,this.createParticles(t.x+t.width/2,t.y+t.height/2,15,t.color))}}else this.player.x+this.player.width>t.x&&this.player.x<t.x+t.width&&(this.player.x<t.x?(this.player.x=t.x-this.player.width,this.player.x<=0&&this.handlePlayerCrush()):this.player.x=t.x+t.width)}},{key:"handlePlayerCrush",value:function(){this.player.health=Math.max(0,this.player.health-2),this.updateHealthDisplay(),this.createParticles(this.player.x+this.player.width,this.player.y+this.player.height/2,3,"#ff0000"),this.effectsManager.triggerDamageFlash(),this.player.mushroomPowerActive&&this.player.deactivateMushroomPower(this.createParticles.bind(this)),this.player.health<=0&&this.endGame()}},{key:"draw",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.background.draw(this.ctx,this.frameCount);for(var t=0;t<this.platforms.length;t++){var e=this.platforms[t];if(!(e.x+e.width<=0||e.x>=this.canvas.width))if("ground"===e.type){var i=this.ctx.createLinearGradient(0,e.y,0,e.y+e.height);i.addColorStop(0,"#555"),i.addColorStop(1,"#333"),this.ctx.fillStyle=i,this.ctx.fillRect(e.x,e.y,e.width,e.height),this.ctx.strokeStyle="#444",this.ctx.lineWidth=1;for(var s=0;s<e.width;s+=40)this.ctx.beginPath(),this.ctx.moveTo(e.x+s,e.y),this.ctx.lineTo(e.x+s,e.y+e.height),this.ctx.stroke()}else if("shelf"===e.type)this.ctx.fillStyle="#777",this.ctx.fillRect(e.x,e.y,e.width,e.height),this.ctx.fillStyle="#999",this.ctx.fillRect(e.x,e.y,e.width,3),this.ctx.fillStyle="#555",this.ctx.fillRect(e.x,e.y+e.height-3,e.width,3);else if("pillar"===e.type){var a=this.ctx.createLinearGradient(e.x,0,e.x+e.width,0);a.addColorStop(0,"#666"),a.addColorStop(.5,"#888"),a.addColorStop(1,"#666"),this.ctx.fillStyle=a,this.ctx.fillRect(e.x,e.y,e.width,e.height),this.ctx.strokeStyle="#777",this.ctx.lineWidth=1;for(var h=0;h<e.height;h+=30)this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y+h),this.ctx.lineTo(e.x+e.width,e.y+h),this.ctx.stroke()}}for(var o=0;o<this.obstacles.length;o++){var r=this.obstacles[o];r.x+r.width<=0||r.x>=this.canvas.width||r.draw(this.ctx,this.frameCount)}for(var n=0;n<this.powerUps.length;n++){var l=this.powerUps[n];if(this.ctx.fillStyle=l.color,this.ctx.beginPath(),this.ctx.arc(l.x+l.width/2,l.y+l.height/2,l.width/2,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#fff","health"===l.type)this.ctx.fillRect(l.x+l.width/2-2,l.y+l.height/4,4,l.height/2),this.ctx.fillRect(l.x+l.width/4,l.y+l.height/2-2,l.width/2,4);else if("weapon"===l.type){var c=l.x+l.width/2,d=l.y+l.height/2,y=l.width/2-2,u=l.width/4;this.ctx.beginPath();for(var p=0;p<10;p++){var m=p%2==0?y:u,g=2*Math.PI*p/10-Math.PI/2,f=c+Math.cos(g)*m,v=d+Math.sin(g)*m;0===p?this.ctx.moveTo(f,v):this.ctx.lineTo(f,v)}this.ctx.closePath(),this.ctx.fill()}else"mushroom"===l.type&&(this.ctx.fillStyle="#ff0000",this.ctx.beginPath(),this.ctx.arc(l.x+l.width/2,l.y+l.height/2-2,l.width/2-2,0,Math.PI,!0),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(l.x+l.width/2-3,l.y+l.height/2-2,6,l.height/2),this.ctx.fillStyle="#ffffff",this.ctx.beginPath(),this.ctx.arc(l.x+l.width/2-5,l.y+l.height/2-5,2,0,2*Math.PI),this.ctx.arc(l.x+l.width/2+3,l.y+l.height/2-7,2,0,2*Math.PI),this.ctx.fill());this.ctx.shadowColor=l.color,this.ctx.shadowBlur=10,this.ctx.beginPath(),this.ctx.arc(l.x+l.width/2,l.y+l.height/2,l.width/2+2,0,2*Math.PI),this.ctx.stroke(),this.ctx.shadowBlur=0}for(var w=0;w<this.specialTokens.length;w++){var b=this.specialTokens[w];this.ctx.fillStyle=b.color,this.ctx.beginPath(),this.ctx.arc(b.x+b.width/2,b.y+b.height/2,b.width/2,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#000",this.ctx.beginPath(),this.ctx.arc(b.x+b.width/2,b.y+b.height/2,b.width/4,0,2*Math.PI),this.ctx.fill(),this.ctx.shadowColor=b.color,this.ctx.shadowBlur=10,this.ctx.beginPath(),this.ctx.arc(b.x+b.width/2,b.y+b.height/2,b.width/2+2,0,2*Math.PI),this.ctx.stroke(),this.ctx.shadowBlur=0}this.player.draw(this.ctx,this.frameCount,this.inputManager.keys);for(var x=0;x<this.enemies.length;x++){var S=this.enemies[x];S.x+S.width<=0||S.x>=this.canvas.width||S.draw(this.ctx,this.frameCount,this.player)}for(var P=0;P<this.projectiles.length;P++){var M=this.projectiles[P];M.x+M.width<=0||M.x>=this.canvas.width||M.y+M.height<=0||M.y>=this.canvas.height||(this.ctx.fillStyle=M.color,M.isGlowing&&(this.ctx.shadowColor=M.color,this.ctx.shadowBlur=10),this.ctx.fillRect(M.x,M.y,M.width,M.height),M.isGlowing&&(this.ctx.shadowBlur=0))}for(var k=0,T=0;T<this.particles.length&&k<50;T++){var C=this.particles[T];C.x<=0||C.x>=this.canvas.width||C.y<=0||C.y>=this.canvas.height||(this.ctx.fillStyle=C.color,this.ctx.beginPath(),this.ctx.arc(C.x,C.y,C.size,0,2*Math.PI),this.ctx.fill(),k++)}this.drawUI(),this.effectsManager.draw(this.ctx)}},{key:"animate",value:function(t){var e=t-this.lastFrameTime;this.lastFrameTime=t||0;var i=Math.min(e,100),s=i/16.67;this.gameStarted||this.gameOver||(0===this.startScreenToggleTimer&&console.log("Timer started: 5s"),this.startScreenToggleTimer+=i,this.startScreenToggleTimer>=5e3&&(console.log("Timer completed"),this.startScreenToggleTimer=0,this.toggleStartScreenAndScoreboard())),this.gameOver||this.isPaused?this.isPaused||!this.gameStarted&&!this.gameOver?(this.draw(),this.animationFrameId=requestAnimationFrame(this.animate.bind(this))):this.animationFrameId=null:(this.update(s),this.draw(),this.animationFrameId=requestAnimationFrame(this.animate.bind(this)))}},{key:"spawnEnemy",value:function(){var t,e,i=[{color:"#f00",width:30,height:30,speed:1,health:30,maxHealth:30,points:100,tentacles:6},{color:"#a00",width:40,height:40,speed:.6,health:60,maxHealth:60,points:200,tentacles:8},{color:"#faa",width:25,height:25,speed:1.3,health:20,maxHealth:20,points:150,tentacles:5},{color:"#f55",width:50,height:50,speed:.4,health:100,maxHealth:100,points:300,tentacles:10}],s=Math.min(Math.floor(this.score/1e3),i.length-1),a=i[Math.floor(Math.random()*(s+1))];Math.random()<.5?(t=Math.random()<.5?-a.width:this.canvas.width,e=Math.random()*this.canvas.height):(t=Math.random()*this.canvas.width,e=-a.height),this.enemies.push(new c(t,e,a,this.canvas)),Math.random()<.3&&this.soundManager.playAlienWhisper()}},{key:"spawnPowerUp",value:function(t,e){var i,s,a=["health","weapon","mushroom"],h=a[Math.floor(Math.random()*a.length)];switch(h){case"health":i="#ff3366",s=25;break;case"weapon":default:i="#ff0",s=20;break;case"mushroom":i="#ff0000",s=25}var o=this.canvas.height-50;e+s>o+10&&(e=o+10-s),this.powerUps.push({x:t,y:e,width:s,height:s,type:h,color:i})}},{key:"spawnSpecialToken",value:function(t,e){var i=this.canvas.height-50;e+20>i+10&&(e=i+10-20),this.specialTokens.push({x:t,y:e,width:20,height:20,color:"#ff00ff"})}},{key:"createParticles",value:function(t,e,i,s){for(var a=0;a<i;a++){var h=Math.random()*Math.PI*2,o=3*Math.random()+1;this.particles.push({x:t,y:e,size:3*Math.random()+2,velX:Math.cos(h)*o,velY:Math.sin(h)*o,color:s})}}},{key:"updateHealthDisplay",value:function(){"number"==typeof this.player.health&&!isNaN(this.player.health)&&isFinite(this.player.health)||(this.player.health=this.player.maxHealth),this.player.health=Math.min(this.player.health,this.player.maxHealth);var t=this.player.health/this.player.maxHealth*100;this.healthBar.style.width="".concat(t,"%"),this.healthValue.textContent=Math.round(this.player.health),this.healthBar.style.background=t>60?"linear-gradient(to right, #0f0, #0f0)":t>30?"linear-gradient(to right, #ff0, #ff0)":"linear-gradient(to right, #f00, #f00)"}},{key:"spawnMushroomPowerUp",value:function(t,e){var i=this.canvas.height-50;e+25>i+10&&(e=i+10-25),this.powerUps.push({x:t,y:e,width:25,height:25,type:"mushroom",color:"#ff0000"}),this.createParticles(t+12.5,e+12.5,15,"#ff0000")}},{key:"showLevelAnnouncement",value:function(t){var e=this,i=this.levelManager.currentLevel+1;this.levelAnnouncement.innerHTML="LEVEL ".concat(i,"<br>").concat(t),this.levelAnnouncement.classList.remove("active","fade-out"),this.levelAnnouncement.offsetWidth,this.levelAnnouncement.classList.add("active"),setTimeout((function(){e.levelAnnouncement.classList.remove("active"),e.levelAnnouncement.classList.add("fade-out")}),3e3)}},{key:"generateTerrain",value:function(){this.platforms=[];for(var t=this.canvas.height-50,e=Math.ceil(this.canvas.width/100)+4,i=0;i<e;i++){var s=i,a=20*Math.sin(.5*s);this.platforms.push({x:100*i,y:t+a,width:101,height:50-a,type:"ground"})}for(var h=0;h<5;h++){var o=300+400*h,r=t-100-h%3*50;this.platforms.push({x:o,y:r,width:150,height:20,type:"shelf"}),this.platforms.push({x:o+65,y:r+20,width:20,height:t-r-20,type:"pillar"})}}},{key:"triggerElonToasty",value:function(){this.effectsManager.triggerElonToasty()}},{key:"removeEnemyFromExplosionSets",value:function(t){var e,i=function(t){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=Y(t))){e&&(t=e);var i=0,s=function(){};return{s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,h=!0,o=!1;return{s:function(){e=e.call(t)},n:function(){var t=e.next();return h=t.done,t},e:function(t){o=!0,a=t},f:function(){try{h||null==e.return||e.return()}finally{if(o)throw a}}}}(this.obstacles);try{for(i.s();!(e=i.n()).done;){var s=e.value;("car"===s.type||"cybertruck"===s.type||"car_explosion"===s.type||"cybertruck_explosion"===s.type)&&s.isExploding&&s.explosionHitEnemies&&s.explosionHitEnemies.has(t)&&s.explosionHitEnemies.delete(t)}}catch(t){i.e(t)}finally{i.f()}}},{key:"validateLevelObstaclePlacement",value:function(){for(var t=this.levelManager.getAllLevels(),e=0;e<t.length;e++){var i=t[e],s=i.elements.filter((function(t){return"obstacle"===t.type}));s.sort((function(t,e){return t.position-e.position}));for(var a=0;a<s.length-1;a++){var h=s[a],o=s[a+1],r=50;"car"===h.subtype&&(r=180),"cybertruck"===h.subtype&&(r=200),"box"===h.subtype&&(r=40),o.subtype,o.subtype,o.subtype;var n=r+20;o.position-h.position<n&&console.warn("Potential obstacle overlap in level ".concat(e+1,' "').concat(i.name,'": ')+"".concat(h.subtype," (id: ").concat(h.id,") at position ").concat(h.position," ")+"may overlap with ".concat(o.subtype," (id: ").concat(o.id,") at position ").concat(o.position,". ")+"Consider increasing distance to at least ".concat(n," pixels."))}}}},{key:"goToNextLevel",value:function(){if(this.levelManager){var t=this.levelManager.getAllLevels(),e=(this.levelManager.currentLevel+1)%t.length;console.log("Navigating to next level: ".concat(e+1));var i=this.levelManager.loadLevel(e);this.levelDisplay&&(this.levelDisplay.textContent=i.name),this.showLevelAnnouncement(i.name),this.soundManager.playSound("powerUp",.5)}}},{key:"goToPreviousLevel",value:function(){if(this.levelManager){var t=this.levelManager.getAllLevels(),e=(this.levelManager.currentLevel-1+t.length)%t.length;console.log("Navigating to previous level: ".concat(e+1));var i=this.levelManager.loadLevel(e);this.levelDisplay&&(this.levelDisplay.textContent=i.name),this.showLevelAnnouncement(i.name),this.soundManager.playSound("powerUp",.5)}}},{key:"drawUI",value:function(){if(this.gameStarted){var t=this.ctx;t.font="16px Arial",t.fillStyle="#fff",t.textAlign="left",t.fillText("Score: ".concat(this.score),20,30)}}},{key:"showMissionComplete",value:function(){this.gameStarted=!1,this.gameOver=!1,this.missionCompleteScore.textContent=this.score,this.missionCompleteScreen.style.display="block",this.missionCompleteScreen.querySelector("h1").textContent="MISSION COMPLETE",this.nameChars=Array.from(document.querySelectorAll(".name-char")),this.currentNameIndex=0,this.playerName=["_","_","_","_","_","_"],this.updateNameDisplay(!0),this.nameInputSection&&(this.nameInputSection.style.display="block"),this.enterKeyButton&&(this.enterKeyButton.style.display="flex");var t=document.getElementById("mission-complete-instruction");t&&(t.style.display="none",t.innerHTML='Press <span class="control-key">SPACE</span> to restart'),this.soundManager.stopBackgroundMusic(),this.soundManager.playSound("victory",.7)}},{key:"handleNameInput",value:function(t){var e="block"===this.missionCompleteScreen.style.display,i="block"===this.gameOverScreen.style.display;if(e||i){var s=Date.now();if(!(s-this.lastKeyTime<this.keyDebounceTime)){this.lastKeyTime=s,e?this.nameChars:this.gameOverNameChars;var a=e?this.playerName:this.gameOverPlayerName,h=e?this.currentNameIndex:this.gameOverCurrentNameIndex;if("Backspace"===t?h>0&&(a[--h]="_"):/^[a-zA-Z0-9 ]$/.test(t)&&h<6&&(a[h]=t.toUpperCase(),h=Math.min(h+1,5)),e){this.currentNameIndex=h;try{var o=document.getElementById("name-input-section");o&&o.__x&&(o.__x.$data.name=H(a),o.__x.$data.currentIndex=h)}catch(t){console.error("Error updating Alpine.js state:",t)}}else{this.gameOverCurrentNameIndex=h;try{var r=document.getElementById("game-over-name-input-section");r&&r.__x&&(r.__x.$data.name=H(a),r.__x.$data.currentIndex=h)}catch(t){console.error("Error updating Alpine.js state:",t)}}this.updateNameDisplay(e)}}}},{key:"updateNameDisplay",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=t?this.nameChars:this.gameOverNameChars,i=t?this.playerName:this.gameOverPlayerName,s=t?this.currentNameIndex:this.gameOverCurrentNameIndex;if(e&&0!==e.length||(console.warn("Name characters not found for ".concat(t?"mission complete":"game over"," screen")),t?this.nameChars=Array.from(document.querySelectorAll(".name-char")):this.gameOverNameChars=Array.from(document.querySelectorAll(".game-over-name-char")),!(t&&0===this.nameChars.length||!t&&0===this.gameOverNameChars.length))){(t?this.nameChars:this.gameOverNameChars).forEach((function(t,e){if(t)try{t.textContent=i[e],t.classList.toggle("active",e===s),t.style.display="inline-flex",t.style.visibility="visible"}catch(t){console.error("Error updating character element at index ".concat(e,":"),t)}else console.warn("Character element at index ".concat(e," is undefined"))}));try{var a=t?document.getElementById("name-input-section"):document.getElementById("game-over-name-input-section");a&&a.__x&&(a.__x.$data.name=H(i),a.__x.$data.currentIndex=s)}catch(t){console.error("Error updating Alpine.js state:",t)}}else console.error("Unable to find name character elements for ".concat(t?"mission complete":"game over"," screen"))}},{key:"saveScore",value:function(){var t,e=this;try{var i=document.getElementById("name-input-section");t=i&&i.__x?i.__x.$data.name.join("").replace(/_/g," ").trim():this.playerName.join("").replace(/_/g," ").trim()}catch(e){console.error("Error accessing Alpine.js state:",e),t=this.playerName.join("").replace(/_/g," ").trim()}var s=t||"UNKNOWN";console.log("Saving score for ".concat(s,": ").concat(this.score)),this.nameInputSection&&(this.nameInputSection.style.display="none"),fetch("/api/scores",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s,score:String(this.score)})}).then((function(t){if(!t.ok)throw new Error("Failed to save score");return t.json()})).then((function(t){console.log("Score saved successfully:",t),e.fetchScores();var i=document.getElementById("mission-complete-instruction");i&&(i.style.display="block")})).catch((function(t){console.error("Error saving score:",t);var e=document.getElementById("mission-complete-instruction");e&&(e.innerHTML='Error saving score. Press <span class="control-key">SPACE</span> to restart',e.style.display="block")}))}},{key:"saveGameOverScore",value:function(){var t,e=this;try{var i=document.getElementById("game-over-name-input-section");t=i&&i.__x?i.__x.$data.name.join("").replace(/_/g," ").trim():this.gameOverPlayerName.join("").replace(/_/g," ").trim()}catch(e){console.error("Error accessing Alpine.js state:",e),t=this.gameOverPlayerName.join("").replace(/_/g," ").trim()}var s=t||"UNKNOWN";console.log("Saving game over score for ".concat(s,": ").concat(this.score)),this.gameOverNameInputSection&&(this.gameOverNameInputSection.style.display="none"),fetch("/api/scores",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s,score:String(this.score)})}).then((function(t){if(!t.ok)throw new Error("Failed to save score");return t.json()})).then((function(t){console.log("Game over score saved successfully:",t),e.fetchScores();var i=document.getElementById("restart-instruction");i&&(i.style.display="block");var s=document.getElementById("view-scoreboard");s&&(s.style.display="block")})).catch((function(t){console.error("Error saving game over score:",t);var e=document.getElementById("restart-instruction");e&&(e.innerHTML='Error saving score. Press <span class="control-key">SPACE</span> to restart',e.style.display="block");var i=document.getElementById("view-scoreboard");i&&(i.style.display="block")}))}},{key:"showScoreboard",value:function(){var t=this;if(this.scoreboardOverlay.style.display="flex",this.gameStarted||this.gameOver){var e=document.getElementById("close-scoreboard");e&&(e.style.display="block")}else{var i=document.getElementById("close-scoreboard");i&&(i.style.display="none"),this.startInstructionElement||(this.startInstructionElement=document.getElementById("start-instruction"));var s=document.querySelector("#scoreboard-start-instruction");if(!s){(s=document.createElement("p")).id="scoreboard-start-instruction",s.className="clickable",this.startInstructionElement?s.innerHTML=this.startInstructionElement.innerHTML:s.innerHTML='Press <span class="control-key">SPACE</span> to start';var a=document.querySelector(".scoreboard-content");a&&a.appendChild(s)}}var h=document.querySelector(".scoreboard-body");this.scoresLoaded&&this.scores.length>0?this.displayScores(this.scores,h):this.scoresError?(h.innerHTML='<div class="empty-message">Failed to load scores: '.concat(this.scoresError,"</div>"),this.fetchScores()):(h.innerHTML='<div class="loading-spinner"></div>',this.scoresLoaded||fetch("/api/scores").then((function(t){if(!t.ok)throw new Error("Failed to fetch scores");return t.json()})).then((function(e){t.scores=e,t.scoresLoaded=!0,t.scoresError=null,t.displayScores(e,h)})).catch((function(e){console.error("Error fetching scores:",e),h.innerHTML='<div class="empty-message">Failed to load scores</div>',t.scoresError=e.message})))}},{key:"displayScores",value:function(t,e){if(e.innerHTML="",t&&t.length>0)t.sort((function(t,e){return e.score-t.score})),t.slice(0,10).forEach((function(t,i){var s=document.createElement("div");s.className="scoreboard-row";var a=document.createElement("div");a.className="rank",a.textContent=(i+1).toString();var h=document.createElement("div");h.className="name",h.textContent=t.name?t.name.substring(0,6).toUpperCase():"UNKNOWN";var o=document.createElement("div");o.className="score",o.textContent=t.score.toString(),s.appendChild(a),s.appendChild(h),s.appendChild(o),e.appendChild(s)}));else{var i=document.createElement("div");i.className="empty-message",i.textContent="No scores available yet",e.appendChild(i)}}},{key:"hideScoreboard",value:function(){this.scoreboardOverlay.style.display="none"}},{key:"toggleStartScreenAndScoreboard",value:function(){this.showingScoreboard?(this.startScreen.style.display="block",this.hideScoreboard(),this.showingScoreboard=!1):(this.startScreen.style.display="none",this.showScoreboard(),this.showingScoreboard=!0)}}],e&&X(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();document.addEventListener("DOMContentLoaded",(function(){var t=document.getElementById("gameCanvas"),e=new $(t);e.resetGame(),requestAnimationFrame(e.animate)}))})();